---
title: "Preparation for Policy Guidebook"
output: 
  html_notebook: 
    number_sections: yes
    toc: yes
    fig_caption: yes
editor_options: 
  chunk_output_type: console
---



```{r Global_settings, include=FALSE}

## Loading packages
source(here::here("libraries.R"))

theme_set(theme_yy())

# dir_modelResults <- paste0(here::here(),"/Outputs/")
dir_modelResults <- paste0(here::here(),"/Outputs_500sims/")
dir_outputs      <- paste0(here::here(),"/Outputs_Analysis/") 


# Global parameters for analysis
dr     <- 0.075 # discount rate
dr_low <- 0.03  # lower discount rate
infl  <- 0.02  # assumed inflation rate
Nyear <- 40    # Number of sim years for contribution analysis
cola_baseline <- 0.015

DC_EECrate <- 0.025
DC_ERCrate <- 0.028

# run names for policy runs to show in results
policy_select <- c("baseline", 
									 "cola_return", "cola_returnSmooth", "cola_returnSmooth_calib",  
									 "cola_FR", "cola_FR_calib",  
									 "EEC_sharedADCfloor", "EEC_return", "EEC_returnSmooth", "EEC_FR", "hybrid_DB")

runnames_show1 <- c("baseline",

										"cola_return",
										"cola_returnSmooth",
										"cola_FR",
										
										"cola_returnSmooth_calib",
										"cola_FR_calib",
										
										"cola_returnSmooth_calib_FR100",
										"cola_FR_calib_FR100",
                    
										"EEC_return",
										"EEC_returnSmooth",
										"EEC_FR"
										# "EEC_sharedADCfloor"

										#"hybrid_DB"
										)

runnames_show1_labels <- c(
	baseline           = "Baseline",
	cola_return        = "Contingent COLA:\nReturn",
	cola_returnSmooth  = "Contingent COLA:\nReturn smoothed",
	cola_FR            = "Contingent COLA:\nFunded ratio",
	
	cola_returnSmooth_calib  = "Contingent COLA:\nReturn smoothed \ncalib",
	cola_FR_calib            = "Contingent COLA:\nFunded ratio \ncalib",
	
	cola_returnSmooth_calib_FR100  = "Contingent COLA:\nReturn smoothed \ncalib FR100",
	cola_FR_calib_FR100      = "Contingent COLA:\nFunded ratio \ncalib FR100",
	
	EEC_return         = "Contingent EEC:\nReturn",
	EEC_returnSmooth   = "Contingent EEC:\nReturn smoothed",
	EEC_FR             = "Contingent EEC:\nFunded ratio"
)





runnames_show2 <- c("baseline", 
										
										"cola_return", 
										"cola_returnSmooth", 
										
										"cola_FR",
										
										"cola_returnSmooth_calib", 
										"cola_FR_calib",
										
										"cola_FR_FR100",
										"cola_FR_calib_FR100"
										
										#"cola_FRramp",
										#"cola_FRramp_FR100"
										)


runnames_show2_labels <- c(
	baseline           = "Baseline",
	cola_return        = "Contingent COLA: \n return",
	cola_returnSmooth  = "Contingent COLA: \n return Smoothed",
	cola_FR            = "Contingent COLA: \n Funded ratio\nYear-1 funded ratio 75%",
	
	cola_returnSmooth_calib  = "Contingent COLA: \n return Smoothed \ncalib",
	cola_FR_calib            = "Contingent COLA: \n Funded ratio\nYear-1 funded ratio 75%\ncalib",
	
  cola_FR_FR100      = "Contingent COLA: \n Funded ratio\nYear-1 funded ratio 100%",
	cola_FR_calib_FR100= "Contingent COLA: \n Funded ratio\nYear-1 funded ratio 100% \ncalib"
)




runnames_show_calib <- c("baseline",

										"cola_return",
										"cola_returnSmooth",
										"cola_FR",
                    
										"cola_returnSmooth_calib",
										"cola_FR_calib",
										
										"cola_returnSmooth_calib_FR100",
										"cola_FR_calib_FR100",
										
										"EEC_return",
										"EEC_returnSmooth",
										"EEC_FR"
										)

runnames_show_calib_labels <- c(
	baseline           = "Baseline",
	cola_return        = "Contingent COLA:\nReturn",
	cola_returnSmooth  = "Contingent COLA:\nReturn smoothed",
	cola_FR            = "Contingent COLA:\nFunded ratio",
	
	cola_returnSmooth_calib  = "Contingent COLA:\nReturn smoothed \ncalib",
	cola_FR_calib            = "Contingent COLA:\nFunded ratio \ncalib",
	
	cola_returnSmooth_calib_FR100  = "Contingent COLA:\nReturn smoothed \ncalib FR100",
	cola_FR_calib_FR100            = "Contingent COLA:\nFunded ratio \ncalib FR100",
	
	
	EEC_return         = "Contingent EEC:\nReturn",
	EEC_returnSmooth   = "Contingent EEC:\nReturn smoothed",
	EEC_FR             = "Contingent EEC:\nFunded ratio"
)

										
										


```


```{r Loading_results, include = FALSE}

source(here::here("Analysis_loadingResults.R"))
# Outputs: 
   # results_all
   # run_labels


```



# Calibration

```{r calib, echo = FALSE}

# Distribution of 40-year COLA with 75% initial funded ratio
df_cola <- 
	results_all %>% 
	filter(year %in% 1:40) %>% 
	# filter(year %in% 16:55) %>% 
	filter(sim >= 1, str_detect(runname, "cola|baseline") ) %>% 
	group_by(runname, sim) %>%
	summarise(runname_wlabel = unique(runname_wlabel),
						cola_avg  = prod(1 + cola_actual[-n()])^(1/(n() - 1)) - 1)

df_cola_qtiles <- 
	df_cola %>% 
	summarise(runname_wlabel = unique(runname_wlabel),
						cola_avg_q10 = quantile(cola_avg, 0.1),
						cola_avg_q25 = quantile(cola_avg, 0.25),
						cola_avg_q50 = quantile(cola_avg, 0.50),
						cola_avg_q75 = quantile(cola_avg, 0.75),
						cola_avg_q90 = quantile(cola_avg, 0.90)
						)
df_cola_qtiles


df_cola_qtiles %>% 
	filter(runname %in% runnames_show_calib) %>% 
	mutate(runname = factor(runname, levels = runnames_show_calib,
													         labels = runnames_show_calib_labels)) %>% 
	ggplot(aes(x = runname)) + 
	geom_boxplot(width = 0.3,
							 stat = "identity",
							 aes(ymin   = cola_avg_q10,
							 		lower  = cola_avg_q25,
							 		middle = cola_avg_q50,
							 		upper  = cola_avg_q75,
							 		ymax   = cola_avg_q90)
	) + 
	geom_hline(yintercept =
						 filter(df_cola_qtiles, runname == "baseline") %>% pull(cola_avg_q50),
						 linetype = 2) +
	coord_cartesian(ylim = c(0, 0.025)) + 
	scale_y_continuous(breaks = seq(0, 1, 0.0025), labels = percent) + 
	labs(title = "Distribution of 40-year compound average COLA",
			 subtitle = NULL,# fig_subtitle,
			 x = NULL, 
			 y = "Compound annual COLA")



```



```{r quintiles, echo = FALSE, warning=FALSE}

# Grouping variables

## Grouping by 40-year compound return 

# Dividing simulations into 5 groups based 40-year CAGR, difference in ERC rate:
#    1) 90th percentile and above []
#    2) 75th~90th percentile [)
#    3) 25th~75th percentile [)
#    4) 25th percentile and below [)
# Grouping can be done based on other variables (e.g. std of return)

df_CAGR40 <- 
results_all %>% 
	filter(runname == "baseline", sim >= 1) %>% 
	group_by(sim) %>% 
	summarise(CAGR40 = get_geoReturn(i.r)) 
  #summarise(CAGR40 = sd(i.r)) 

grpVals_CAGR40 <-
	df_CAGR40 %>% 
	summarise(CAGR40_pinf= Inf,
		        CAGR40_q90 = quantile(CAGR40, 0.80),
						CAGR40_q75 = quantile(CAGR40, 0.60),
						CAGR40_q50 = quantile(CAGR40, 0.50),
						CAGR40_q25 = quantile(CAGR40, 0.40),
						CAGR40_q10 = quantile(CAGR40, 0.20),
						CAGR40_ninf= -Inf,
	) 


grpVals_CAGR40_vector <- unlist(grpVals_CAGR40[1,2:6])

df_CAGR40 %<>% 
	mutate(
		grp_CAGR40 = cut(CAGR40, unlist(grpVals_CAGR40[1,])[-4], label = F )
		# grp_CAGR40 = case_when(
		# CAGR40 >= grpVals_CAGR40$CAGR40_q90 ~ 1,
		# CAGR40 >= grpVals_CAGR40$CAGR40_q75 & CAGR40 < grpVals_CAGR40$CAGR40_q90 ~ 2,
		# CAGR40 >= grpVals_CAGR40$CAGR40_q25 & CAGR40 < grpVals_CAGR40$CAGR40_q75 ~ 3,
		# CAGR40 >= grpVals_CAGR40$CAGR40_q10 & CAGR40 < grpVals_CAGR40$CAGR40_q25 ~ 4,
		# CAGR40 < grpVals_CAGR40$CAGR40_q10 ~ 5,
		# TRUE ~ NA_real_) 
	)


grp_CAGR40_labels <- c(
	"< 6.5%",
  "6.5%~7.2%",
  "7.2%~7.9%",
  "7.9%~8.6%",
  "> 8.6%"
)


```



# Analysis of ERC

```{r ERC_prep, echo = FALSE, warning=FALSE}

results_stch_FR75 <-  
  results_all %>% 
	# filter(!str_detect(runname, "FR100")) %>% 
	# filter(sim >= 1, year %in% 21:40) 
	filter(sim >= 1, year <= Nyear) 


## PV ERC and EEC 
df_PVC <- 
  results_stch_FR75 %>% 
	select(runname, runname_wlabel, sim, year, policy_type, ERC, EEC, UAAL) %>% 
	group_by(runname, sim) %>% 
	summarise(
		        runname_wlabel = unique(runname_wlabel),
						
		        # PV of ERC
		        ERC_PV         = sum(ERC / (1 + dr)^(year - 1)),
						ERCwUAAL_PV    = sum(ERC / (1 + dr)^(year - 1)) + UAAL[year == max(year)] / (1 + unique(dr))^(max(year) - 1),
						
						# PV of EEC
						EEC_PV         = sum(EEC / (1 + dr)^(year - 1))
						)
# df_PVC

## Percentiles of PVC for each policy
df_PVC_qtiles <- 
	df_PVC %>% 
	summarise(runname_wlabel = unique(runname_wlabel),
						
						ERC_PV_q90 = quantile(ERC_PV, 0.90),
						ERC_PV_q75 = quantile(ERC_PV, 0.75),
						ERC_PV_q50 = quantile(ERC_PV, 0.50),
						ERC_PV_q25 = quantile(ERC_PV, 0.25),
						ERC_PV_q10 = quantile(ERC_PV, 0.1),
						
						ERCwUAAL_PV_q90 = quantile(ERCwUAAL_PV, 0.90),
						ERCwUAAL_PV_q75 = quantile(ERCwUAAL_PV, 0.75),
						ERCwUAAL_PV_q50 = quantile(ERCwUAAL_PV, 0.50),
						ERCwUAAL_PV_q25 = quantile(ERCwUAAL_PV, 0.25),
						ERCwUAAL_PV_q10 = quantile(ERCwUAAL_PV, 0.1),
						
						EEC_PV_q90 = quantile(EEC_PV, 0.90),
						EEC_PV_q75 = quantile(EEC_PV, 0.75),
						EEC_PV_q50 = quantile(EEC_PV, 0.50),
						EEC_PV_q25 = quantile(EEC_PV, 0.25),
						EEC_PV_q10 = quantile(EEC_PV, 0.1)
						)

# df_PVC_qtiles
# Why PV ERC of SDRS is so low, even with final UAAL?


## distributions(percentiles of differences)

df_PVC_sim2sim_m3 <- 
	df_PVC %>% 
	select(runname, sim, ERC_PV) %>% 
	left_join(filter(df_PVC, runname == "baseline") %>% ungroup() %>%  select(sim, ERC_PV_baseline = ERC_PV), by = "sim") %>% 
	mutate(diff_ERC_PV     = ERC_PV -  ERC_PV_baseline,
				 diff_ERC_PV_pct = 100* (ERC_PV / ERC_PV_baseline - 1)) %>% 
	group_by(runname) %>% 
	summarise(
		dff_ERC_PV_pct_q90 = quantile(diff_ERC_PV_pct, 0.90),
	  dff_ERC_PV_pct_q75 = quantile(diff_ERC_PV_pct, 0.75),
	  dff_ERC_PV_pct_q50 = quantile(diff_ERC_PV_pct, 0.50),
	  dff_ERC_PV_pct_q25 = quantile(diff_ERC_PV_pct, 0.25),
	  dff_ERC_PV_pct_q10 = quantile(diff_ERC_PV_pct, 0.10)
		) %>% 
	gather(Percentile, value, -runname) %>% 
	spread(runname, value) 


## Maximum increase in ERC rate WITHIN 5 years

# Note:
#  - Need to take into account the possibility that the changes in less then 5 years
#    are greater than the 5-year change. The method below takes care of this. 

# x <- filter(results_stch, sim ==1, runname == "cola_baseline") %>% pull("ERC_PR")
# zoo::rollapply(x, width = 6, get_nyearMax, fill = NA, align = "right")


df_ERCMaxChg <- 
	results_stch_FR75 %>% 
	select(runname, runname_wlabel, sim, year, policy_type, ERC_PR) %>%
	group_by(runname, sim) %>% 
	mutate(   ERC_PR_chg5y    = rollapply(ERC_PR, width = 6, get_nyearMax, fill = NA, align = "right")) %>% # zoo::rollapply
	summarise(runname_wlabel = unique(runname_wlabel),
		        ERC_PR_chg5yMax = max(ERC_PR_chg5y, na.rm = TRUE))

# df_ERCMaxChg


df_ERCMaxChg_qtile <- 
	df_ERCMaxChg %>% 
	summarise(runname_wlabel = unique(runname_wlabel),
						
						ERC_PR_chg5yMax_q90 = quantile(ERC_PR_chg5yMax, 0.90),
						ERC_PR_chg5yMax_q75 = quantile(ERC_PR_chg5yMax, 0.75),
						ERC_PR_chg5yMax_q50 = quantile(ERC_PR_chg5yMax, 0.50),
						ERC_PR_chg5yMax_q25 = quantile(ERC_PR_chg5yMax, 0.25),
						ERC_PR_chg5yMax_q10 = quantile(ERC_PR_chg5yMax, 0.1)
						)
# df_ERCMaxChg_qtile


# Proability of ERC rate rising by more than 5% in 40 years
```



## Distribution of PV ERC within each policy

```{r, warning=FALSE, echo = FALSE}

df_PVC_qtiles %>% 
	mutate_at(vars(-runname,-runname_wlabel), ~ 100 * . / df_PVC_qtiles$ERC_PV_q50[df_PVC_qtiles$runname == "baseline"]) %>% 
	select(runname, contains("ERC_PV")) %>% 
	filter(runname %in% runnames_show1) %>% 
	mutate(runname = factor(runname, levels = runnames_show1)) %>% 
	gather(Percentile, value, -runname) %>% 
	mutate(Percentile = factor(Percentile) %>% fct_inorder()) %>% 
	spread(runname, value) %>% 
	kable(digits = 1, caption = "Percentiles of normalized PV ERC within each policy", format = "pandoc")


fig_title    <- "Distributions of the present value 40-year employer contribution \nunder different COLA policies"
df_PVC_qtiles_plot <- 
  df_PVC_qtiles %>% 
	mutate_at(vars(-runname,-runname_wlabel), ~ 100 * . / df_PVC_qtiles$ERC_PV_q50[df_PVC_qtiles$runname == "baseline"]) %>% 
	select(runname, contains("ERC_PV")) %>% 
	filter(runname %in% runnames_show1) %>% 
	mutate(runname = factor(runname, levels = runnames_show1, 
													         labels = runnames_show1_labels)) 
  
  df_PVC_qtiles_plot %>% 
	ggplot(aes(x = runname)) + 
	geom_boxplot(width = 0.3,
							 stat = "identity",
							 aes(ymin   = ERC_PV_q10,
							 	 	lower   = ERC_PV_q25,
							 		middle  = ERC_PV_q50,
							 		upper   = ERC_PV_q75,
							 		ymax    = ERC_PV_q90)
	) + 
	geom_hline(yintercept =
						 filter(df_PVC_qtiles_plot, runname == "baseline") %>% pull(ERC_PV_q50),
						 linetype = 2) +
	coord_cartesian(ylim = c(0, 200)) + 
	scale_y_continuous(breaks = seq(0, 300, 20)) + 
	labs(title = fig_title,
			 subtitle = NULL,# fig_subtitle,
			 x = NULL, 
			 y = "Present value of ERC")
	

```







## Overall cost reduction effect

**Cost Q1, Present value of ERC over 40 years compared to baseline: median differences in 5 return groups** 

```{r tab_ERC_PV, echo = FALSE}
df_PVC_sim2sim2 <-
	df_PVC %>% 
	select(runname, sim, ERC_PV) %>% 
	left_join(filter(df_PVC, runname == "baseline") %>% ungroup %>% select(sim, ERC_PV_baseline = ERC_PV), by = "sim" ) %>% 
  left_join(df_CAGR40, by = "sim") %>% 
	mutate(ERC_PV          = 100 * ERC_PV / df_PVC_sim2sim$baseline[df_PVC_sim2sim$Percentile == "ptile50"],
				 ERC_PV_baseline = 100 * ERC_PV_baseline / df_PVC_sim2sim$baseline[df_PVC_sim2sim$Percentile == "ptile50"],
		     ERC_PV_diff     = ERC_PV - ERC_PV_baseline,
				 ERC_PV_diff_pct = 100*( ERC_PV / ERC_PV_baseline - 1)
				 )

fun_sum <- median
# fun_sum <- mean

df_PVC_sim2sim2 %<>% 
	group_by(runname, grp_CAGR40) %>% 
	summarise(ERC_PV          = fun_sum(ERC_PV),
						ERC_PV_diff     = fun_sum(ERC_PV_diff),
						ERC_PV_diff_pct = fun_sum(ERC_PV_diff_pct)
						) %>% 
  arrange(runname, desc(grp_CAGR40))


df_tab_ERC_PV <- 
df_PVC_sim2sim2 %>% 
	select(runname, grp_CAGR40 , ERC_PV_diff_pct) %>% 
	spread(runname, ERC_PV_diff_pct) %>% 
	select(grp_CAGR40, one_of(runnames_show1)) %>% 
	left_join(df_PVC_sim2sim2 %>%  # adding median baseline PV ERC in each group
							filter(runname == "baseline") %>% 
							ungroup() %>% 
							select(grp_CAGR40, ERC_PV_baseline = ERC_PV), 
						by = "grp_CAGR40") %>% 
	select(grp_CAGR40, ERC_PV_baseline, everything(), -baseline) %>% 
	gather(policy, value, -grp_CAGR40) %>% 
	mutate(policy = factor(policy, levels = c("ERC_PV_baseline", runnames_show1),
												         labels = c("PV employer cost\nin Baseline", runnames_show1_labels)),
												 ) %>% 
	spread(policy, value) %>% 
	mutate(Return_Range = grp_CAGR40_labels) %>% 
	select(grp_CAGR40, Return_Range, everything())
	# filter(grp_CAGR40 %in% c(1, 3, 5)) %>% 
	
tab_ERC_PV <- 
	df_tab_ERC_PV %>% 
	flextable() %>%
	add_header_row(values = "Percentage differences in PV employer contribution\n from baseline by long-term return quintile\n(Median values within groups)", 
								 colwidths = 7) %>% 
	# autofit() %>% 
	height(part = "body",   height = .6) %>%
	height(part = "header", i = 2, height = 1) %>%
	height(part = "header", i = 1, height = .8) %>%
	hrule(rule = "exact", part = "all") %>%
	bg(part = "header", i = 2, bg = "gray90") %>% 
	width(j = 1, width = 0.8) %>%
	width(j = 2, width = 1.8) %>%
	width(j = 3:7, width = 1.4) %>%
	fontsize(size = 14, part = "all") %>% 
	fontsize(size = 18, part = "header", i = 1) %>% 
	# autofit(add_w = 1) %>% 
	align(j = 1:2, align = "center", part = "all")  %>% 
	colformat_num(j = 4:7, digits = 1, suffix = "%") %>% 
	colformat_num(j = 3, digits = 1) %>% 
	set_header_labels(grp_CAGR40 = "Return\nquintile", 
										Return_Range = "Range of 40-year\ncompound return")

tab_ERC_PV %>% dim_pretty()	
tab_ERC_PV
save_as_image(tab_ERC_PV, path = here::here("Outputs_Analysis/tab_ERC_PV.png"))


tab_ERC_PV_3rows <- 
	df_tab_ERC_PV %>% 
  filter(grp_CAGR40 %in% c(1, 3, 5)) %>% 
	flextable() %>%
	add_header_row(values = "Percentage differences in PV employer contribution\n from baseline by long-term return quintile\n(Median values within groups)", 
								 colwidths = 7) %>% 
	# autofit() %>% 
	height(part = "body",   height = .6) %>%
	height(part = "header", i = 2, height = 1) %>%
	height(part = "header", i = 1, height = .8) %>%
	hrule(rule = "exact", part = "all") %>%
	bg(part = "header", i = 2, bg = "gray90") %>% 
	width(j = 1, width = 0.8) %>%
	width(j = 2, width = 1.8) %>%
	width(j = 3:7, width = 1.4) %>%
	fontsize(size = 14, part = "all") %>% 
	fontsize(size = 18, part = "header", i = 1) %>% 
	# autofit(add_w = 1) %>% 
	align(j = 1:2, align = "center", part = "all")  %>% 
	colformat_num(j = 4:7, digits = 1, suffix = "%") %>% 
	colformat_num(j = 3, digits = 1) %>% 
	set_header_labels(grp_CAGR40 = "Return\nquintile", 
										Return_Range = "Range of 40-year\ncompound return")

tab_ERC_PV_3rows
save_as_image(tab_ERC_PV_3rows, path = here::here("Outputs_Analysis/tab_ERC_PV_3rows.png"))


```




```{r tab_ERC_vol1, echo = FALSE}

fun_sum <- median
# fun_sum <- mean

df_tab_ERC_vol1 <- 
df_ERCMaxChg %>% 
	select(runname, sim, ERC_PR_chg5yMax) %>% 
	mutate(ERC_PR_chg5yMax = 100 * ERC_PR_chg5yMax) %>% 
	left_join(df_CAGR40, by = "sim") %>% 
	group_by(runname, grp_CAGR40) %>% 
	summarise(ERC_PR_chg5yMax_med = fun_sum(ERC_PR_chg5yMax)) %>% 
  arrange(runname, desc(grp_CAGR40)) %>% 
	filter(runname %in% runnames_show1) %>% 
	spread(runname, ERC_PR_chg5yMax_med) %>% 
	# kable(digits = 1, caption = "Max 5-year ERC change in 40-year CAGR groups, starting FR=75%", format = 'pandoc')
	gather(policy, value, -grp_CAGR40) %>% 
	mutate(policy = factor(policy, levels = c(runnames_show1),
												         labels = c(runnames_show1_labels)),
												 ) %>% 
	spread(policy, value) %>% 
	mutate(Return_Range = grp_CAGR40_labels) %>% 
	select(grp_CAGR40, Return_Range, everything()) 


tab_ERC_vol1 <- 
  df_tab_ERC_vol1 %>% 
	# filter(grp_CAGR40 %in% c(1, 3, 5)) %>% 
	flextable() %>%
	add_header_row(values = "Maximum increase in employer contribution rate in 5 years by long-term return quintile\n(Median values within groups)", 
								 colwidths = 7) %>% 
	# autofit() %>% 
	height(part = "body",   height = .6) %>%
	height(part = "header", i = 2, height = 1) %>%
	height(part = "header", i = 1, height = .7) %>%
	hrule(rule = "exact", part = "all") %>%
	bg(part = "header", i = 2, bg = "gray90") %>% 
	fontsize(size = 14, part = "all") %>% 
	fontsize(size = 18, part = "header", i = 1) %>% 
	width(j = 1, width = 0.8) %>%
	width(j = 2, width = 1.8) %>%
	set_header_labels(grp_CAGR40 = "Return\nquintile", 
										Return_Range = "Range of 40-year\ncompound return") %>% 
	align(j = 1:2, align = "center", part = "all")  %>% 
	width(j = 3:7, width = 1.4) %>% 
	colformat_num(j = 3:7, digits = 1, suffix = "%") 
tab_ERC_vol1


save_as_image(tab_ERC_vol1, path = here::here("Outputs_Analysis/tab_ERC_vol1.png"))


tab_ERC_vol1_3rows <- 
  df_tab_ERC_vol1 %>% 
	filter(grp_CAGR40 %in% c(1, 3, 5)) %>% 
	flextable() %>%
	add_header_row(values = "Maximum increase in employer contribution rate in 5 years by long-term return quintile\n(Median values within groups)", 
								 colwidths = 7) %>% 
	# autofit() %>% 
	height(part = "body",   height = .6) %>%
	height(part = "header", i = 2, height = 1) %>%
	height(part = "header", i = 1, height = .7) %>%
	hrule(rule = "exact", part = "all") %>%
	bg(part = "header", i = 2, bg = "gray90") %>% 
	fontsize(size = 14, part = "all") %>% 
	fontsize(size = 18, part = "header", i = 1) %>% 
	width(j = 1, width = 0.8) %>%
	width(j = 2, width = 1.8) %>%
	set_header_labels(grp_CAGR40 = "Return\nquintile", 
										Return_Range = "Range of 40-year\ncompound return") %>% 
	align(j = 1:2, align = "center", part = "all")  %>% 
	width(j = 3:7, width = 1.4) %>% 
	colformat_num(j = 3:7, digits = 1, suffix = "%") 
tab_ERC_vol1_3rows


save_as_image(tab_ERC_vol1_3rows, path = here::here("Outputs_Analysis/tab_ERC_vol1_3rows.png"))

```



```{r tab_ERC_vol2, echo = FALSE}

df_ERC_hike <-  
  results_stch_FR75 %>% 
	as_tibble() %>% 
	select(runname, sim, year, ERC_PR) %>% 
	group_by(runname, sim) %>% 
	mutate(ERC_hike = cumany( ERC_PR - lag(ERC_PR, 5, Inf) > 0.1) ) %>% 
	group_by(runname, year) %>% 
	summarise(ERC_hike = sum(ERC_hike)/n())


tab_ERC_vol2 <- 
df_ERC_hike %>% 
	filter(runname %in% runnames_show1, year %in% c(10, 20)) %>% 
	spread(runname, ERC_hike) %>% 
	# kable(digits = 2, caption = "Probability of ERC rate rising more than 10% \nwithin a 5-year period in the first 10 or 20 years", format = "pandoc")
	gather(policy, value, -year) %>% 
	
  mutate(policy = factor(policy, levels = c(runnames_show1),
												         labels = c(runnames_show1_labels)),
				 value = value * 100) %>% 
	spread(policy, value) %>% 
	
	flextable() %>%
	add_header_row(values = "Probability of employer contribution rate rising more than 10% \nwithin a 5-year period in the first 10 or 20 years", 
								 colwidths = 6) %>% 
	# autofit() %>% 
	height(part = "body",   height = .6) %>%
	height(part = "header", i = 1, height = .8) %>%
	height(part = "header", i = 2, height = 1) %>%
	hrule(rule = "exact", part = "all") %>%
	bg(part = "header", i = 2, bg = "gray90") %>% 
	width(j = 1, width = 0.8) %>%
	width(j = 2:6, width = 1.4) %>%
	fontsize(size = 14, part = "all") %>% 
	fontsize(size = 18, part = "header", i = 1) %>% 
	# autofit(add_w = 1) %>% 
	align(j = 1, align = "center", part = "all")  %>% 
	colformat_num(j = 2:6, digits = 1, suffix = "%") %>% 
	set_header_labels(year = "Up to year"
									   )
tab_ERC_vol2

save_as_image(tab_ERC_vol2, path = here::here("Outputs_Analysis/tab_ERC_vol2.png"))
	
```











# Analysis of Benefits


**Q1. Impact on the overall benefit level (protection against inflation; focus on total PV benefit)**

**Question:** To what extent would contingent COLA policies weaken the (overall) protection against inflation?

COLA is intended to provide protection against inflation. Even for plans with fixed COLA, few of them provide full protection against inflation (usually fraction of CPI) Contingent COLA policies can even further weaken the inflation protection: lower average COLA; same average COLA but weaker protection in bad scenarios (uncertainty in the strength of protection).

**Measures:**

- Show distribution of 40-year compound COLA

1. Two probability based measures for the risk of low overall benefit:
	- 1.1[MFC] Risk of actual overall benefit significantly lower than expected(baseline): Prob of PV benefit is below 90% of PV benefit under baseline
	- 1.2 Risk of failing to protect against inflation, Measure: Prob of PV benefit is below 90% of PV benefit with full inflation protection


2. (TODO) sim-to-sim comparison of PVB: (3 general ways to compare PV-type results)
 - 2.1 differences from baseline at quantiles of baseline PVB (can also be grouped)
 - 2.2* [MFC] median differences in long-term return groups
 - 2.3 percentiles of differences from baseline PVB 

3.*(?) Distribution of overall benefit level: PV (discount only or + attribution ) Benefit for age 60-100: compared to full projection. The PV values may not be staightforward to understand, but is good to have as a measure for overall benefit. It is also easier to see the tail risk here: how low the PV benefit (campared to full inflation protection or baseline) 

**Key results**

 - The probabilities of of total PVB lower than 90% of the baseline level are generally very low. 
 
 - [summary of results from sim-to-sim comparisons]
 
 - For the FR-based cola policies, the starting funded ratio and the design of ramp can have big impact on the results.   


**Discussion**
 - The choice of discount rate for the calculation of PVB: does it make sense to heavily discount benefits at higher ages? Discounting with the survival rate at each age makes sense because it is less likely for retirees to receive benefits at higher ages so those benefits values less to them upon retirement. But it may not make sense to use the return assumption of 7% as the discount rate, because discounting benefit actually reflect individual's time preference of consumption. May make more sense to discount factor in discounted utility function.[check values commonly used in macro models.]
 - If a lower discount rate is used, the differences from the baseline PVB will become larger. (b/c differences accumulate over time)
 

Article on discouting future benefits and costs: https://www.epa.gov/sites/production/files/2017-09/documents/ee-0568-06.pdf


**Q2. Impact on the stability of retirement income (focus on the variability of annual benefit)**

**Question:** Would contingent COLA policies lead to declines in real benefit that may affect retirees welfare? (Related to Q1 but broader)
DB plans are intended to provide secured retirement income. But contingent COLA policies create uncertainty in the benefit payments. The policies may cause deteriorated standard-of-living if retirees experience large declines in real benefit payments that may force them to change their consumption behavior.

**Measures:**

1. Measures for the risk of experiencing low benefit sometime during retirement
	- 1.1 [MFC, to table] Chance of experiencing low benefit at some point: Prob of real benefits falling below 90% of starting benefit in any year up to a given year
	- 1.2 Percentiles of the lowest annual real benefit level in 40 years (pick the lowest real B in each sim, then construct the distribution across all sims)  

2. Measures for large decline of benefit in a short period of time
	- 2.1 Chance of sharp decline of real benefit: Prob of real benefits falling by 10% of starting benefit in any year up to a given year
	- 2.2 [MFC, with return grps]Percentiles of max (or 95th ptile) decrease in real benefit in 5-years for a single cohort: percentiles (Tail-risks)

3. [MFC, with return grps]Range of real benefit level at age 80. Supplemental to other measures. Easier to see the tail risk: how low the real benefit can become (10th percentile)?


**Key results**

- measure 1.1: Very high probability (50%+) of benefit falling below 90% of starting benefit when starting with 75% funded ratio. The probabilities are significantly lower with 100% starting FR. 

- Measure 1.2 Retirees may experience much lower level of benefits under cola_return and cola_FR policies, even in median cases. FR ramp and 100% starting FR can have big impact.  


**Additional question:** How would the initial funded ratio affect the impact of COLA policies contingent upon funded ratio?


Note: Both interest rate (discount rate) and mortality are taken into account in the calculation of PV




```{r benefit_prep, include = FALSE}

# Cohorts to examine:
	# Cohort 1: Retired at age 60 in year 1 (1 - 41)
	# Cohort 2: Retired at age 60 in year 15 (15- 55)
		#  - After the 15-year amortization period for the year-1 UAAL 

# Normalize the benefit at age 60 to 100. 
# Need qxm.r in decrement table 

load("Inputs/riskShaing_demographics_100y.RData")

## Create a model run with cola_actual = infl and append to results_all

df_colaFull <- 
  results_all %>% 
	filter(runname == "baseline") %>% 
	mutate(cola_actual = infl,
				 runname     = "cola_full")

df_benefit_y1 <- 
	bind_rows(results_all, df_colaFull) %>% 
	filter(sim >= 1, year %in% 1:41) %>% 
	select(runname, runname_wlabel, policy_type, sim, year, cola_actual) %>% 
	group_by(runname, sim) %>% 
	mutate(age = 60:100) %>% 
	left_join(decrement %>% ungroup() %>% filter(ea == min(ea))  %>% select(age, qxm.r) , by = "age") %>% 
	mutate(qxm.r   = ifelse(age == max(age), 1, qxm.r),
				 fct_qxm = ifelse(age == 60, 1, lag(cumprod(1-qxm.r))),
				 fct_dr      = 1/(1 + dr)^(age - 60),
				 fct_dr_low  = 1/(1 + dr_low)^(age - 60),
				 B       = 100 * ifelse(age == 60, 1, lag(cumprod(1+cola_actual))),
				 B_real  = B / (1 + infl)^(age - 60),
				 B_real_chg5y = rollapply(B_real, width = 6, get_nyearMin, fill = NA, align = "right")
				 )
# df_benefit_y1 


df_benefit_qtile_y1 <- 
	df_benefit_y1 %>% 
	summarise(runname_wlabel = unique(runname_wlabel),
						B_PV_dr    = sum(B * fct_dr),
						B_PV_tot   = sum(B* fct_dr * fct_qxm),
						B_real_chg5yMin = min(B_real_chg5y, na.rm = TRUE),
						B_real_age80   = B_real[age == 80]		
	) %>% 
	summarise(runname_wlabel = unique(runname_wlabel),
						
						B_PV_dr_q90 = quantile(B_PV_dr, 0.90),
						B_PV_dr_q75 = quantile(B_PV_dr, 0.75),
						B_PV_dr_q50 = quantile(B_PV_dr, 0.50),
						B_PV_dr_q25 = quantile(B_PV_dr, 0.25),
						B_PV_dr_q10 = quantile(B_PV_dr, 0.1),
						
						B_PV_tot_q90 = quantile(B_PV_tot, 0.90),
						B_PV_tot_q75 = quantile(B_PV_tot, 0.75),
						B_PV_tot_q50 = quantile(B_PV_tot, 0.50),
						B_PV_tot_q25 = quantile(B_PV_tot, 0.25),
						B_PV_tot_q10 = quantile(B_PV_tot, 0.1),
						
						B_real_chg5yMin_q90 = quantile(B_real_chg5yMin, 0.90),
						B_real_chg5yMin_q75 = quantile(B_real_chg5yMin, 0.75),
						B_real_chg5yMin_q50 = quantile(B_real_chg5yMin, 0.50),
						B_real_chg5yMin_q25 = quantile(B_real_chg5yMin, 0.25),
						B_real_chg5yMin_q10 = quantile(B_real_chg5yMin, 0.1),
						
						B_real_age80_q90 = quantile(B_real_age80, 0.90),
						B_real_age80_q75 = quantile(B_real_age80, 0.75),
						B_real_age80_q50 = quantile(B_real_age80, 0.50),
						B_real_age80_q25 = quantile(B_real_age80, 0.25),
						B_real_age80_q10 = quantile(B_real_age80, 0.1)
						)



# runs_benefit <- c("cola_full", "baseline", "cola_return", "cola_FR", "cola_SDRS", "cola_FR_FR100", "cola_SDRS_FR100")
# runs_benefit_lables <- c(
# 	"COLA equal to inflation",
# 	"Baseline \nYear-1 funded ratio 100%",
# 	"Contingent COLA: \nreturn",
# 	"Contingent COLA: \nFunded ratio threshold",
# 	"SDRS",
# 	"Contingent COLA: \nFunded ratio threshold\nYear-1 funded ratio 100%",
# 	"SDRS \nYear-1 funded ratio 100%"
# )
	

# Distribution of 40-year COLA with 75% initial funded ratio
df_cola <- 
	results_all %>% 
	filter(year %in% 1:40) %>% 
	# filter(year %in% 16:55) %>% 
	filter(sim >= 1, str_detect(runname, "cola|baseline") ) %>% 
	group_by(runname, sim) %>%
	summarise(runname_wlabel = unique(runname_wlabel),
						cola_avg  = prod(1 + cola_actual[-n()])^(1/(n() - 1)) - 1)

df_cola_qtiles <- 
	df_cola %>% 
	summarise(runname_wlabel = unique(runname_wlabel),
						cola_avg_q10 = quantile(cola_avg, 0.1),
						cola_avg_q25 = quantile(cola_avg, 0.25),
						cola_avg_q50 = quantile(cola_avg, 0.50),
						cola_avg_q75 = quantile(cola_avg, 0.75),
						cola_avg_q90 = quantile(cola_avg, 0.90)
						)

```



## Impact on overall benefit level and protection against inflation

**Distribution of 40-year compound COLA**

```{r dist_COLA, fig.width=8, echo = FALSE}

fig_title    <- "Distributions of 40-year compound annual COLA \nunder different COLA policies"
# fig_subtitle <- "Starting funded ratio: 75%"
fig_cola_qtiles_FR75 <- 
	df_cola_qtiles %>% 
	filter(runname %in% runnames_show2) %>% 
	mutate(runname = factor(runname, levels = runnames_show2,
													         labels = runnames_show2_labels)) %>% 
	ggplot(aes(x = runname)) + 
	geom_boxplot(width = 0.3,
							 stat = "identity",
							 aes(ymin   = cola_avg_q10,
							 		lower  = cola_avg_q25,
							 		middle = cola_avg_q50,
							 		upper  = cola_avg_q75,
							 		ymax   = cola_avg_q90)
	) + 
	geom_hline(yintercept =
						 filter(df_cola_qtiles, runname == "baseline") %>% pull(cola_avg_q50),
						 linetype = 2) +
	coord_cartesian(ylim = c(0, 0.025)) + 
	scale_y_continuous(breaks = seq(0, 1, 0.0025), labels = percent) + 
	labs(title = fig_title,
			 subtitle = NULL,# fig_subtitle,
			 x = NULL, 
			 y = "Compound annual COLA")
fig_cola_qtiles_FR75


```

**Benefit Q1, Measure 1: Two probability based measures for the risk of low overall benefit**:

- 1.1[MFC] Risk of actual overall benefit significantly lower than expected(baseline): Prob of PV benefit is below 90% of PV benefit under baseline
- 1.2 Risk of failing to protect against inflation: Prob of PV benefit is below 90% of PV benefit with full inflation protection

```{r echo=FALSE}

df_benefit_PV <- 
	df_benefit_y1 %>% 
	summarise(runname_wlabel = unique(runname_wlabel),
						# B_PV_dr    = sum(B * fct_dr),
						B_PV_tot    = sum(B* fct_dr * fct_qxm),
						B_PV_tot_drLow   = sum(B* fct_dr_low * fct_qxm)
	)

df_low_pvB <- 
df_benefit_PV %>% 
	left_join(filter(df_benefit_PV, runname == "cola_full") %>% 
							ungroup %>%  select(sim, B_PV_tot_full = B_PV_tot), by = "sim") %>% 
  left_join(filter(df_benefit_PV, runname == "baseline") %>% 
  						ungroup %>%  select(sim, B_PV_tot_baseline = B_PV_tot), by = "sim") %>% 
	mutate(dif_full     = B_PV_tot / B_PV_tot_full,
				 dif_baseline = B_PV_tot / B_PV_tot_baseline
				 ) %>% 
	group_by(runname) %>% 
	summarise(Low_pvB_full_pct90     = 100 * sum(dif_full     <= 0.9)/n(),
						Low_pvB_baseline_pct90 = 100 * sum(dif_baseline <= 0.9)/n(),
						
						Low_pvB_full_pct95     = 100 * sum(dif_full     <= 0.95)/n(),
						Low_pvB_baseline_pct95 = 100 * sum(dif_baseline <= 0.95)/n(),
						)


df_low_pvB %>% 
	filter(runname %in% runnames_show2) %>% 
	select(runname, contains("Low_pvB_baseline")) %>% 
	mutate(runname = factor(runname, levels = runnames_show2)) %>% 
	gather(Measure, value, -runname) %>% 
	spread(runname, value) %>% 
	# kable(digits = 1, caption = "Probability (%) of PV benefit below 90%/95% of that in baseline (cola = 1.5%)", format = 'pandoc')
  gather(policy, value, -Measure) %>% 
	mutate(policy = factor(policy, levels = c(runnames_show2),
												         labels = c(runnames_show2_labels)),
				 
				 Measure = factor(Measure, levels = c("Low_pvB_baseline_pct90", "Low_pvB_baseline_pct95"),
				 								           labels = c("Lower than 90% of Baseline", "Lower than 95% of Baseline")
				 								                     ),
				 value = value / 100
												 ) %>% 
	spread(policy, value) %>% 
	select(-Baseline) %>% 
  # kable(digits = 1, caption = "Median percentage difference from baseline by return group (%)", format = "pandoc")
  gt(rowname_col = c("Measure")) %>% 
	fmt_percent(
    columns = 2:8,
    decimals = 1) %>% 
	tab_header(
    title = "Probability of present value of benefit below 90% or 95% of the level in baseline"
  ) %>% 
	tab_stubhead(label = "Measure")






# df_low_pvB %>%
# 	filter(runname %in% runnames_show2) %>%
# 	select(runname, contains("Low_pvB_full")) %>%
# 	mutate(runname = factor(runname, levels = runnames_show2)) %>%
# 	gather(Measure, value, -runname) %>%
# 	spread(runname, value) %>%
# 	kable(digits = 1, caption = "Probability (%) of PV benefit below 90%/95% of that with full inflation protection(cola = 2%)", format = 'pandoc')

```

**Benefit Q1, Measure 2: Sim-to-Sim comparisons of PV benefit**

2.2 median differences in long-term return groups 

The give groups and their ranges of compound average return are

- Group1: Lower than 10th percentile (`r round(grpVals_CAGR40_vector[5], 4)*100`%)
- Group2: 10th to 25th percentile (`r round(grpVals_CAGR40_vector[5], 4)*100`% to `r round(grpVals_CAGR40_vector[4], 4)*100`%)
- Group3: 25th to 75th percentile (`r round(grpVals_CAGR40_vector[4], 4)*100`% to `r round(grpVals_CAGR40_vector[2], 4)*100`%)
- Group4: 75th to 90th percentile (`r round(grpVals_CAGR40_vector[2], 4)*100`% to `r round(grpVals_CAGR40_vector[1], 4)*100`%)
- Group5: higher than 90th percentile (`r round(grpVals_CAGR40_vector[1], 4)*100`%)

```{r echo = FALSE, warning= FALSE}


df_PVB_sim2sim_grp <- 
  df_benefit_PV %>% 
	select(-runname_wlabel) %>% 
	left_join(filter(df_benefit_PV, runname == "baseline") %>% ungroup %>% 
							select(sim, B_PV_tot_baseline = B_PV_tot, B_PV_tot_drLow_baseline = B_PV_tot_drLow), by = "sim") %>% 
	left_join(df_CAGR40, by = "sim") %>% 
	mutate(
		     #ERC_PV          = 100 * ERC_PV / df_PVC_sim2sim$baseline[df_PVC_sim2sim$Percentile == "ptile50"],
				 #ERC_PV_baseline = 100 * ERC_PV_baseline / df_PVC_sim2sim$baseline[df_PVC_sim2sim$Percentile == "ptile50"],
		     B_PV_tot_diff     = B_PV_tot - B_PV_tot_baseline,
				 B_PV_tot_diff_pct = 100*( B_PV_tot / B_PV_tot_baseline - 1),
				 
				 B_PV_tot_drLow_diff     = B_PV_tot_drLow - B_PV_tot_drLow_baseline,
				 B_PV_tot_drLow_diff_pct = 100*( B_PV_tot_drLow / B_PV_tot_drLow_baseline - 1)
				 )
	
fun_sum <- median
# fun_sum <- mean

df_PVB_sim2sim_grp %<>% 
	group_by(runname, grp_CAGR40) %>% 
	summarise(B_PV_tot          = fun_sum(B_PV_tot),
						B_PV_tot_diff     = fun_sum(B_PV_tot_diff),
						B_PV_tot_diff_pct = fun_sum(B_PV_tot_diff_pct),
						
						B_PV_tot_drLow          = fun_sum(B_PV_tot_drLow),
						B_PV_tot_drLow_diff     = fun_sum(B_PV_tot_drLow_diff),
						B_PV_tot_drLow_diff_pct = fun_sum(B_PV_tot_drLow_diff_pct)
						) %>% 
  arrange(runname, desc(grp_CAGR40))



df_PVB_sim2sim_grp %>% 
	select(runname, grp_CAGR40, B_PV_tot_diff_pct) %>% 
	filter(runname %in% runnames_show2) %>% 
	ungroup() %>% 
	mutate(runname = factor(runname, levels = runnames_show2)) %>% 
	spread(runname, B_PV_tot_diff_pct) %>% 
	select(-baseline) %>% 
	left_join(df_PVB_sim2sim_grp %>% 
							filter(runname == "baseline") %>% 
							ungroup() %>% 
	            select(grp_CAGR40, B_PV_tot),
						by = "grp_CAGR40"
						) %>% 
	select(baseline_PVB = B_PV_tot, everything()) %>% 
	# kable(digits = 1, caption = "Median percentage difference from baseline by return group (%), DR = 7.5%", format = 'pandoc')
	gather(policy, value, -grp_CAGR40) %>% 
	mutate(policy = factor(policy, levels = c("baseline_PVB", runnames_show2),
												         labels = c("PV benefit\nin Baseline", runnames_show2_labels)),
												 ) %>% 
	spread(policy, value) %>% 
	mutate(Return_Range = grp_CAGR40_labels) %>% 
	select(grp_CAGR40, Return_Range, everything()) %>% 
	
  # kable(digits = 1, caption = "Median percentage difference from baseline by return group (%)", format = "pandoc")
  gt(rowname_col = "grp_CAGR40") %>% 
	fmt_number(
    columns = 4:10,
    decimals = 1) %>% 
	fmt_number(
    columns = 3,
    decimals = 0) %>% 
	tab_header(
    title = "Median percentage difference in present value of benefit from baseline by return group (%)"
  ) %>% 
	tab_stubhead(label = "Group")
	
	


# df_PVB_sim2sim_grp %>% 
# 	select(runname, grp_CAGR40, B_PV_tot_drLow_diff_pct) %>% 
# 	filter(runname %in% runnames_show2) %>% 
# 	ungroup() %>% 
# 	mutate(runname = factor(runname, levels = runnames_show2)) %>% 
# 	spread(runname, B_PV_tot_drLow_diff_pct) %>% 
# 	select(-baseline) %>% 
# 	left_join(df_PVB_sim2sim_grp %>% 
# 							filter(runname == "baseline") %>% 
# 							ungroup() %>% 
# 	            select(grp_CAGR40, B_PV_tot_drLow),
# 						by = "grp_CAGR40"
# 						) %>% 
# 	select(baseline_PVB = B_PV_tot_drLow, everything()) %>% 
# 	kable(digits = 1, caption = "Median percentage difference from baseline by return group (%), DR = 3%", format = 'pandoc')


```


**Benefit Q1, Measure 3: Distribution of PV Benefit**

```{r echo = FALSE}

## Q1 measures
  # B_PV total and B_real_age80
  # runs: baseline, cola_return, cola_FR, cola_SDRS, cola_FR100, cola_SDRS_100

tab_benefit1 <- 
df_benefit_qtile_y1 %>% 
	filter(runname %in% c("cola_full", runnames_show2)) %>% 
	select(runname, starts_with("B_PV_tot")) %>% 
	gather(Var, values, -runname) %>%
	mutate(runname = factor(runname, levels=  c("cola_full", runnames_show2)),
		     # Var = factor(Var) %>% fct_inorder(),
				 values = ifelse(str_detect(Var, "B_PV_tot"),  100 * values / values[runname == "baseline" & Var == "B_PV_tot_q50"], values)
	) %>% 
	spread(runname, values) 
tab_benefit1 %>% knitr::kable(digits = 1)

```

## Impact on the stability of retirement income (variability of annual benefit)


**Benefit Q2, Measure 1: Measures for the risk of experiencing low benefit sometime during retirement**

- Chance of experiencing low benefit in certain years: Prob of real benefits falling below 90% of starting benefit in any year up to a given year
- Percentiles of the lowest annual real benefit level in 40 years (pick the lowest real B in each sim, then construct the distribution across all sims)  


```{r, echo = FALSE}

df_B_low <- 
df_benefit_y1 %>% 
	as_tibble() %>% 
	select(runname, runname_wlabel, sim, year, B_real) %>% 
	group_by(runname, sim) %>% 
	mutate(B_lower90 = cumany(B_real < 90)) %>% 
	group_by(runname, year) %>% 
	summarise(B_lower90 = sum(B_lower90) /n())
	

fig_title <- "Probability of real benefit falling below 90% of starting benefit \nin any year up to a given year"
df_B_low %>% 
	filter(runname %in% runnames_show2) %>% 
	ungroup %>% 
	mutate(runname = factor(runname, levels= runnames_show2)) %>% 
	ggplot(aes(x = year, y = B_lower90, color = runname)) +  
	geom_line() +
	geom_point() + 
	scale_color_manual(values = c("black", "grey50", brewer_pal(type = "qual", palette = "Paired")(6) )) + 
	scale_y_continuous(labels = function(x) percent(x, accuracy = 1)) + 
	labs(title = fig_title,
			 x = "Year",
			 y = "Probability",
			 color = "Policy"
			 )


df_B_low %>% 
	filter(runname %in% runnames_show2, year %in% c(10, 20)) %>% 
	ungroup() %>% 
	mutate(runname = factor(runname, levels = runnames_show2)) %>% 
	spread(runname, B_lower90) %>% 
	# kable(digits = 3, caption = "Probability of real benefit falling below 90% of starting benefit \nin any year up to year 10 and 20", format = "pandoc") %>% 
  gather(policy, value, -year) %>% 
	mutate(policy = factor(policy, levels = c(runnames_show2),
												         labels = c(runnames_show2_labels))
												 ) %>% 
	spread(policy, value) %>% 
	# select(-Baseline) %>% 
  # kable(digits = 1, caption = "Median percentage difference from baseline by return group (%)", format = "pandoc")
  gt(rowname_col = c("year")) %>% 
	fmt_percent(
    columns = 2:9,
    decimals = 1) %>% 
	tab_header(
    title = "Probability of real benefit falling below 90% of starting benefit \nin any year up to year 10 or 20"
  ) %>% 
	tab_stubhead(label = "Up to year")



df_B_lowest <- 
df_benefit_y1 %>% 
	as_tibble() %>% 
	select(runname, runname_wlabel, sim, year, B_real) %>% 
	group_by(runname, sim) %>% 
	summarise(B_lowest = min(B_real)) %>% 
	summarise(B_lowest_q90 = quantile(B_lowest, 0.9),
						B_lowest_q50 = quantile(B_lowest, 0.5),
						B_lowest_q10 = quantile(B_lowest, 0.1)
						)


df_B_lowest %>% 
	filter(runname %in% runnames_show2) %>% 
	ungroup %>%
	mutate(runname = factor(runname, levels= runnames_show2)) %>% 
	gather(Percentile, value, -runname) %>% 
	mutate(Percentile = factor(Percentile) %>% fct_inorder()) %>% 
	spread(runname, value) %>% 
	kable(digits = 1, caption = "Distribution of the lowest annual real benefit level in 40 years (100 in year 1)", format = 'pandoc')
	
	
```




**Benefit Q2, Measure 2: Measures for large decline of benefit in a short period of time**

- Chance of sharp decline of real benefit: Prob of real benefits falling by 8% of starting benefit in any year up to a given year (8% is arbitrary for now)
- Percentiles of max (or 95th ptile) decrease in real benefit in 5-years for a single cohort: percentiles (Tail-risks)



```{r, echo = FALSE}

df_B_drop <- 
df_benefit_y1 %>% 
	as_tibble() %>% 
	select(runname, runname_wlabel, sim, year, B_real) %>% 
	group_by(runname, sim) %>% 
	mutate(B_drop_5 = cumany(B_real - lag(B_real, 5, -Inf) <= -8)) %>% 
	group_by(runname, year) %>% 
	summarise(B_drop_5 = sum(B_drop_5) /n())

# df_B_drop	

fig_title <- "Probability of real benefits falling by 8% of starting benefit \nin any year up to a given year"
df_B_drop %>% 
	filter(runname %in% runnames_show2) %>% 
	ungroup %>% 
	mutate(runname = factor(runname, levels= runnames_show2)) %>% 
	ggplot(aes(x = year, y = B_drop_5, color = runname)) +  
	geom_line() +
	geom_point() + 
	scale_color_manual(values = c("black", "grey50", brewer_pal(type = "qual", palette = "Paired")(6) )) + 
	scale_y_continuous(labels = function(x) percent(x, accuracy = 1)) + 
	labs(title = fig_title,
			 x = "Year",
			 y = "Probability",
			 color = "Policy"
			 )



# Max 5-year benefit change: return groups

fun_sum <- median

df_benefit_y1 %>% 
  summarise(B_real_chg5yMin = min(B_real_chg5y, na.rm = TRUE),
						B_real_age80   = B_real[age == 80]) %>% 
	left_join(df_CAGR40, by = "sim") %>% 
	group_by(runname, grp_CAGR40) %>% 
	summarise(B_real_chg5yMin_med = fun_sum(B_real_chg5yMin)) %>% 
	arrange(runname, desc(grp_CAGR40)) %>% 
	filter(runname %in% runnames_show2) %>% 
	ungroup() %>% 
	mutate(runname = factor(runname, levels = runnames_show2)) %>% 
	spread(runname, B_real_chg5yMin_med) %>% 
	# kable(digits = 1, caption = "Max 5-year decrease in benefit by 40-year CAGR group, starting FR=75%", format = 'pandoc')

	gather(policy, value, -grp_CAGR40) %>% 
	mutate(policy = factor(policy, levels = c("baseline", runnames_show2),
												         labels = c("Baseline", runnames_show2_labels)),
												 ) %>% 
	spread(policy, value) %>% 
	mutate(Return_Range = grp_CAGR40_labels) %>% 
	select(grp_CAGR40, Return_Range, everything()) %>% 
	
  # kable(digits = 1, caption = "Median percentage difference from baseline by return group (%)", format = "pandoc")
  gt(rowname_col = "grp_CAGR40") %>% 
	fmt_number(
    columns = 3:10,
    decimals = 1) %>% 
	tab_header(
    title = "Maximum 5-year decrease (%) in annual benefit, meidan by return group "
  ) %>% 
	tab_stubhead(label = "Group")



	
	
# # Probability of benefit falling below 90% of starting benefit
# df_benefit_probLowBen <- 
# df_benefit_y1 %>% 
# 	filter(runname %in% setdiff(runs_benefit,c("baseline", "cola_full"))) %>% 
# 	ungroup() %>% 
# 	mutate(runname = factor(runname, levels = runs_benefit, labels = runs_benefit_lables)) %>% 
# 	group_by(runname, sim) %>% 
# 	mutate(B_real_low = cumany(B_real <= 90)) %>% 
# 	group_by(runname, year) %>% 
# 	summarise(B_real_low = sum(B_real_low)/n()) 
# 
# 
# fig_title <- "Probability of inflation-adjusted benefit falling below 90% of the year-1 value\n at anytime up ot the given year"
# fig_benefit_probLowBen <- 
# df_benefit_probLowBen %>% 
# 	ggplot(aes(y = B_real_low, x = year, color = runname, shape = runname)) + theme_yy() +
# 	geom_line() + 
# 	geom_point() + 
# 	scale_y_continuous(labels = percent) +
# 	# scale_color_viridis_d(option = "D", begin = 0.3) + 
# 	scale_color_brewer(type = "qual", palette = 3)+
# 	labs(title = fig_title,
# 			 x = "Year",
# 			 y = "Probability",
# 		   color = NULL,
# 			 shape = NULL) +
# 	guides(color = guide_legend(keywidth = 1.5, keyheight = 3))
# fig_benefit_probLowBen
# 
# save_figure(fig_benefit_probLowBen, dir_outputs, w = 9, h = 6 )

```



**Range of real benefit level at age 80**. Supplemental to other measures. Easier to see the tail risk: how low the real benefit can become (10th percentile)?

```{r echo = FALSE}

## Q1 measures
  # B_PV total and B_real_age80
  # runs: baseline, cola_return, cola_FR, cola_SDRS, cola_FR100, cola_SDRS_100

# tab_benefit_age80 <- 
# df_benefit_qtile_y1 %>% 
# 	filter(runname %in% c("cola_full", runnames_show2)) %>% 
# 	select(runname, starts_with("B_real_age80")) %>% 
# 	gather(Var, values, -runname) %>%
# 	mutate(runname = factor(runname, levels=  c("cola_full", runnames_show2)),
# 		     Var = factor(Var) %>% fct_inorder(),
# 	) %>% 
# 	spread(runname, values) 
# tab_benefit_age80 %>% knitr::kable(digits = 1)
# 


fun_sum <- median

df_benefit_y1 %>% 
  summarise(B_real_chg5yMin = min(B_real_chg5y, na.rm = TRUE),
						B_real_age80   = B_real[age == 80]) %>% 
	left_join(df_CAGR40, by = "sim") %>% 
	group_by(runname, grp_CAGR40) %>% 
	summarise(B_real_age80_med = fun_sum(B_real_age80)) %>% 
	arrange(runname, desc(grp_CAGR40)) %>% 
	filter(runname %in% runnames_show2) %>% 
	ungroup() %>% 
	mutate(runname = factor(runname, levels = runnames_show2)) %>% 
	spread(runname, B_real_age80_med) %>% 
	kable(digits = 1, caption = "Real benefit at age 80 by 40-year CAGR group, starting FR=75%", format = 'pandoc')






```



# Deterministic asset shock scenario

```{r echo = FALSE}

## Deterministic asset shock scenarios:

# sim -1: starting FR = 100%
# sim -2: starting FR = 75%

df_assetShock <- 
	results_all %>% 
	filter(sim < 0)


runnames_show_det <- c("baseline", 
										
										  "cola_return", 
											"cola_returnSmooth", 
										  "cola_FR",
											# "cola_FRramp"
							
							        "EEC_return",
											"EEC_returnSmooth",
										  "EEC_FR"
										  
										  # "EEC_sharedADCfloor"
										  #"hybrid_DB"
										)
runnames_show_det_labels <- c(
	baseline           = "Baseline:\nNo risk-sharing",
	cola_return        = "Contingent COLA:\nReturn",
	cola_returnSmooth  = "Contingent COLA:\nReturn smoothed",
	cola_FR            = "Contingent COLA:\nFunded ratio",
	EEC_return         = "Contingent EEC:\nReturn",
	EEC_returnSmooth   = "Contingent EEC:\nReturn smoothed",
	EEC_FR             = "Contingent EEC:\nFunded ratio"
)



df_assetShock_plot <- 
  df_assetShock %>% 
	filter(sim == -2, year <=30, runname %in% runnames_show_det) %>% # sim -2: 75% starting FR
	mutate(SC_PR = SC / PR) %>% 
	select(runname, sim, year,ERC, ERC_PR, FR_MA, NC_PR, EEC_PR, SC_PR, cola_actual) %>% 
	mutate(runname = factor(runname, runnames_show_det),
				 runname_label = factor(runname, labels = runnames_show_det_labels))

# df_assetShock_plot


# Plotting ERC rate  

fig_title <- "Employer contribution rates after the asset shock\nunder different risk-sharing policies"

fig_shock_ERC1 <- 
  df_assetShock_plot %>% 
	filter(year <= 15,
				 runname %in% runnames_show_det[(1:7)]) %>% 
	mutate(Alpha = ifelse(runname %in% runnames_show_det[(1)], 1, 0)) %>% 
	ggplot(aes(x = year, y = ERC_PR, color = runname_label)) +  #alpha = Alpha)) +
	geom_line(size = 1) + 
	geom_point(size = 2) + 
	annotate("rect", xmin = 2, xmax = 3, ymin = -1, ymax = 1, fill = "red", size = 0, alpha = 0.1) +
	annotate("rect", xmin = 3, xmax = 6, ymin = -1, ymax = 1, fill = "yellow", size = 0, alpha = 0.1) +
	annotate("text", x = 2.5, y = 0.29, label = "Asset\nshock\n(-24%)", color = "grey40") +
	annotate("text", x = 4.5, y = 0.29, label = "Recovery\n(12% annually)", color = "grey40") +
	annotate("text", x = 11, y = 0.29, label = "Post-recovery\n(7.5% annually)", color = "grey40") +
  coord_cartesian(ylim = c(0, 0.3))	+
	scale_x_continuous(breaks = seq(0, 100, 1)) +
	scale_y_continuous(breaks = seq(0, 1, 0.05), labels = function(x) percent(x, accuracy = 1)) +
	scale_color_manual(values = c("black", brewer_pal(type = "qual", palette = "Paired")(6) )) +
  scale_alpha_continuous(range = c(0.15,1), guide = FALSE) +
	labs(title = fig_title,
		   x = "Year",
			 y = "Employer contribution rate",
			 color = "Policy") +
  guides(color = guide_legend(keywidth = 1.5, keyheight = 2),
				 shape = guide_legend(keywidth = 1.5, keyheight = 2)
				 )
fig_shock_ERC1

fig_shock_ERC2 <- 
df_assetShock_plot %>% 
	filter(year <= 15,
				 runname %in% runnames_show_det[(1:5)]) %>% 
	mutate(alpha = ifelse(runname %in% runnames_show_det[(1:3)], 1, 0)) %>% 
	ggplot(aes(x = year, y = ERC_PR, color = runname_label, alpha = alpha)) +
	geom_line(size = 1) + 
	geom_point(size = 2) + 
	annotate("rect", xmin = 2, xmax = 3, ymin = -1, ymax = 1, fill = "red", size = 0, alpha = 0.1) +
	annotate("rect", xmin = 3, xmax = 6, ymin = -1, ymax = 1, fill = "yellow", size = 0, alpha = 0.1) +
	annotate("text", x = 2.5, y = 0.29, label = "Asset\nshock\n(-24%)", color = "grey40") +
	annotate("text", x = 4.5, y = 0.29, label = "Recovery\n(12% annually)", color = "grey40") +
  annotate("text", x = 11, y = 0.29, label = "Post-recovery\n(7.5% annually)", color = "grey40") +
	coord_cartesian(ylim = c(0, 0.3))	+
	scale_x_continuous(breaks = seq(0, 100, 1)) + 
	scale_y_continuous(breaks = seq(0, 1, 0.05), labels = function(x) percent(x, accuracy = 1)) +
	scale_color_manual(values = c("black", brewer_pal(type = "qual", palette = "Paired")(4) )) + 
  scale_alpha_continuous(range = c(0.15,1), guide = FALSE) + 
	labs(title = fig_title,
		   x = "Year",
			 y = "Employer contribution rate",
			 color = "Policy") + 
  guides(color = guide_legend(keywidth = 1.5, keyheight = 2),
				 shape = guide_legend(keywidth = 1.5, keyheight = 2)
				 )

fig_shock_ERC3 <- 
df_assetShock_plot %>% 
	filter(year <= 15,
				 runname %in% runnames_show_det[(1:5)]) %>% 
	mutate(alpha = ifelse(!runname %in% runnames_show_det[(2:3)], 1, 0)) %>% 
	ggplot(aes(x = year, y = ERC_PR, color = runname_label, alpha = alpha)) +
	geom_line(size = 1) + 
	geom_point(size = 2) + 
	annotate("rect", xmin = 2, xmax = 3, ymin = -1, ymax = 1, fill = "red", size = 0, alpha = 0.1) +
	annotate("rect", xmin = 3, xmax = 6, ymin = -1, ymax = 1, fill = "yellow", size = 0, alpha = 0.1) +
	annotate("text", x = 2.5, y = 0.29, label = "Asset\nshock\n(-24%)", color = "grey40") +
	annotate("text", x = 4.5, y = 0.29, label = "Recovery\n(12% annually)", color = "grey40") +
  annotate("text", x = 11, y = 0.29, label = "Post-recovery\n(7.5% annually)", color = "grey40") +
  coord_cartesian(ylim = c(0, 0.3))	+
	scale_x_continuous(breaks = seq(0, 100, 1)) + 
	scale_y_continuous(breaks = seq(0, 1, 0.05), labels = function(x) percent(x, accuracy = 1)) +
	scale_color_manual(values = c("black", brewer_pal(type = "qual", palette = "Paired")(4) ))+
  scale_alpha_continuous(range = c(0.1,1), guide = FALSE) + 
	labs(title = fig_title,
		   x = "Year",
			 y = "Employer contribution rate",
			 color = "Policy") + 
  guides(color = guide_legend(keywidth = 1.5, keyheight = 2),
				 shape = guide_legend(keywidth = 1.5, keyheight = 2)
				 )

save_figure(fig_shock_ERC1, fig_folder = "Outputs_Analysis/", scale = 0.9, w = 10, h = 6, dpi =400)
save_figure(fig_shock_ERC2, fig_folder = "Outputs_Analysis/", scale = 0.9, w = 10, h = 6, dpi =400)
save_figure(fig_shock_ERC3, fig_folder = "Outputs_Analysis/", scale = 0.9, w = 10, h = 6, dpi =400)

fig_shock_ERC1
fig_shock_ERC2
fig_shock_ERC3


df_assetShock_plot %>% filter(year == 10)


df_assetShock_plot %>% 
	filter(year <=15) %>% 
	group_by(runname) %>% 
	summarise(ERC = sum(ERC / (1 + 0.075)^(year-1))) %>% 
	mutate(ERC_diff = ERC / ERC[runname == "baseline"] - 1 )




# Plotting FR rate  
df_assetShock_plot %>% 
	filter(year <=20) %>% 
	ggplot(aes(x = year, y = FR_MA, color = runname)) +
	geom_line() + 
	geom_point() + 
  coord_cartesian(ylim = c(0.5, 1))	+
	scale_y_continuous(breaks = seq(0, 1, 0.1), labels = function(x) percent(x, accuracy = 1)) +
	scale_color_manual(values = c("black", brewer_pal(type = "qual", palette = "Paired")(4) ))
# Note that baseline and EEC_FR have the same TOTAL contribution and therefore the same FR. 





load("Inputs/riskShaing_demographics_100y.RData")


df_benefit_det <- 
	results_all %>% 
	filter(sim == -2, year %in% 1:41) %>% 
	select(runname, runname_wlabel, policy_type, sim, year, cola_actual) %>% 
	group_by(runname, sim) %>% 
	mutate(age = 60:100) %>% 
	mutate(
				 B       = 100 * ifelse(age == 60, 1, lag(cumprod(1+cola_actual))),
				 B_real  = B / (1 + infl)^(age - 60)
				 ) %>% 
	filter(runname %in% runnames_show_det, year <= 15) %>% 
	ungroup() %>% 
	mutate(runname = factor(runname, levels = runnames_show_det),
				 runname_label = factor(runname, labels = runnames_show_det_labels))



fig_title <- "Inflation-adjusted annual benefits after the asset shock\nunder different risk-sharing policies"
fig_subtitle <- "Benefit in year 1 = 100"

fig_shock_realB <- 
df_benefit_det %>% 
	filter(runname %in% runnames_show_det[1:3]) %>% 
	ggplot(aes(x = year, y = B_real, color = runname_label)) +
	geom_line(size = 1) + 
	geom_point(size = 2) + 
	annotate("rect", xmin = 2, xmax = 3, ymin = -Inf, ymax = Inf, fill = "red", size = 0, alpha = 0.1) +
	annotate("rect", xmin = 3, xmax = 6, ymin = -Inf, ymax = Inf, fill = "yellow", size = 0, alpha = 0.1) +
	annotate("text", x = 2.5, y = 105, label = "Asset\nshock\n(-24%)", color = "grey40") +
	annotate("text", x = 4.5, y = 105, label = "Recovery\n(12% annually)", color = "grey40") +
  annotate("text", x = 11, y = 105, label = "Post-recovery\n(7.5% annually)", color = "grey40") +
	coord_cartesian(ylim = c(60, 107))	+
	scale_x_continuous(breaks = seq(0, 100, 1)) + 
	scale_y_continuous(breaks = seq(0, 200, 10)) +
	scale_color_manual(values = c("black", brewer_pal(type = "qual", palette = "Paired")(4) ))+
  scale_alpha_continuous(range = c(0.1,1), guide = FALSE) + 
	labs(title = fig_title,
			 subtitle = fig_subtitle,
		   x = "Year",
			 y = "Real annual benefit ",
			 color = "Policy") + 
  guides(color = guide_legend(keywidth = 1.5, keyheight = 2),
				 shape = guide_legend(keywidth = 1.5, keyheight = 2)
				 )
	
fig_shock_realB
save_figure(fig_shock_realB, fig_folder = "Outputs_Analysis/", scale = 0.9, w = 10, h = 6, dpi =400)





## ERC plot for paper


# Plotting ERC rate  

fig_title <- "Employer contribution rates after the asset shock\nunder different risk-sharing policies"

fig_shock_ERCpaper <- 
  df_assetShock_plot %>% 
	filter(year <= 15,
				 runname %in% runnames_show_det[(1:5)]) %>% 
	mutate(Alpha = ifelse(runname %in% runnames_show_det[(1)], 1, 0)) %>% 
	ggplot(aes(x = year, y = ERC_PR, color = runname_label)) +
	geom_line(size = 1) + 
	geom_point(size = 2) + 
	annotate("rect", xmin = 2, xmax = 3, ymin = -1, ymax = 1, fill = "red", size = 0, alpha = 0.1) +
	annotate("rect", xmin = 3, xmax = 6, ymin = -1, ymax = 1, fill = "yellow", size = 0, alpha = 0.1) +
	annotate("text", x = 2.5, y = 0.29, label = "Asset\nshock\n(-24%)", color = "grey40") +
	annotate("text", x = 4.5, y = 0.29, label = "Recovery\n(12% annually)", color = "grey40") +
	annotate("text", x = 11, y = 0.29, label = "Post-recovery\n(7.5% annually)", color = "grey40") +
  coord_cartesian(ylim = c(0, 0.3))	+
	scale_x_continuous(breaks = seq(0, 100, 1)) +
	scale_y_continuous(breaks = seq(0, 1, 0.05), labels = function(x) percent(x, accuracy = 1)) +
	scale_color_manual(values = c("black", brewer_pal(type = "qual", palette = "Paired")(4) )) +
  scale_alpha_continuous(range = c(0.15,1), guide = FALSE) +
	labs(title = fig_title,
		   x = "Year",
			 y = "Employer contribution rate",
			 color = "Policy") +
  guides(color = guide_legend(keywidth = 1.5, keyheight = 2),
				 shape = guide_legend(keywidth = 1.5, keyheight = 2)
				 )
fig_shock_ERCpaper


save_figure(fig_shock_ERCpaper, fig_folder = "Outputs_Analysis/", scale = 0.9, w = 10, h = 6, dpi =400)





```








# Tables for MFC2020


```{r tab_ERC_PV, echo = FALSE}
df_PVC_sim2sim2 <-
	df_PVC %>% 
	select(runname, sim, ERC_PV) %>% 
	left_join(filter(df_PVC, runname == "baseline") %>% ungroup %>% select(sim, ERC_PV_baseline = ERC_PV), by = "sim" ) %>% 
  left_join(df_CAGR40, by = "sim") %>% 
	mutate(ERC_PV          = 100 * ERC_PV / df_PVC_sim2sim$baseline[df_PVC_sim2sim$Percentile == "ptile50"],
				 ERC_PV_baseline = 100 * ERC_PV_baseline / df_PVC_sim2sim$baseline[df_PVC_sim2sim$Percentile == "ptile50"],
		     ERC_PV_diff     = ERC_PV - ERC_PV_baseline,
				 ERC_PV_diff_pct = 100*( ERC_PV / ERC_PV_baseline - 1)
				 )

fun_sum <- median
# fun_sum <- mean

df_PVC_sim2sim2 %<>% 
	group_by(runname, grp_CAGR40) %>% 
	summarise(ERC_PV          = fun_sum(ERC_PV),
						ERC_PV_diff     = fun_sum(ERC_PV_diff),
						ERC_PV_diff_pct = fun_sum(ERC_PV_diff_pct)
						) %>% 
  arrange(runname, desc(grp_CAGR40))


df_tab_ERC_PV <- 
df_PVC_sim2sim2 %>% 
	select(runname, grp_CAGR40 , ERC_PV_diff_pct) %>% 
	spread(runname, ERC_PV_diff_pct) %>% 
	select(grp_CAGR40, one_of(runnames_show1)) %>% 
	left_join(df_PVC_sim2sim2 %>%  # adding median baseline PV ERC in each group
							filter(runname == "baseline") %>% 
							ungroup() %>% 
							select(grp_CAGR40, ERC_PV_baseline = ERC_PV), 
						by = "grp_CAGR40") %>% 
	select(grp_CAGR40, ERC_PV_baseline, everything(), -baseline) %>% 
	gather(policy, value, -grp_CAGR40) %>% 
	mutate(policy = factor(policy, levels = c("ERC_PV_baseline", runnames_show1),
												         labels = c("PV employer cost\nin Baseline", runnames_show1_labels)),
												 ) %>% 
	spread(policy, value) %>% 
	mutate(Return_Range = grp_CAGR40_labels) %>% 
	select(grp_CAGR40, Return_Range, everything())
	# filter(grp_CAGR40 %in% c(1, 3, 5)) %>% 
	
tab_ERC_PV <- 
	df_tab_ERC_PV %>% 
	flextable() %>%
	add_header_row(values = "Percentage differences in PV employer contribution\n from baseline by long-term return quintile\n(Median values within groups)", 
								 colwidths = 7) %>% 
	# autofit() %>% 
	height(part = "body",   height = .6) %>%
	height(part = "header", i = 2, height = 1) %>%
	height(part = "header", i = 1, height = .8) %>%
	hrule(rule = "exact", part = "all") %>%
	bg(part = "header", i = 2, bg = "gray90") %>% 
	width(j = 1, width = 0.8) %>%
	width(j = 2, width = 1.8) %>%
	width(j = 3:7, width = 1.4) %>%
	fontsize(size = 14, part = "all") %>% 
	fontsize(size = 18, part = "header", i = 1) %>% 
	# autofit(add_w = 1) %>% 
	align(j = 1:2, align = "center", part = "all")  %>% 
	colformat_num(j = 4:7, digits = 1, suffix = "%") %>% 
	colformat_num(j = 3, digits = 1) %>% 
	set_header_labels(grp_CAGR40 = "Return\nquintile", 
										Return_Range = "Range of 40-year\ncompound return")

tab_ERC_PV %>% dim_pretty()	
tab_ERC_PV
save_as_image(tab_ERC_PV, path = here::here("Outputs_Analysis/tab_ERC_PV.png"))


tab_ERC_PV_3rows <- 
	df_tab_ERC_PV %>% 
  filter(grp_CAGR40 %in% c(1, 3, 5)) %>% 
	flextable() %>%
	add_header_row(values = "Percentage differences in PV employer contribution\n from baseline by long-term return quintile\n(Median values within groups)", 
								 colwidths = 7) %>% 
	# autofit() %>% 
	height(part = "body",   height = .6) %>%
	height(part = "header", i = 2, height = 1) %>%
	height(part = "header", i = 1, height = .8) %>%
	hrule(rule = "exact", part = "all") %>%
	bg(part = "header", i = 2, bg = "gray90") %>% 
	width(j = 1, width = 0.8) %>%
	width(j = 2, width = 1.8) %>%
	width(j = 3:7, width = 1.4) %>%
	fontsize(size = 14, part = "all") %>% 
	fontsize(size = 18, part = "header", i = 1) %>% 
	# autofit(add_w = 1) %>% 
	align(j = 1:2, align = "center", part = "all")  %>% 
	colformat_num(j = 4:7, digits = 1, suffix = "%") %>% 
	colformat_num(j = 3, digits = 1) %>% 
	set_header_labels(grp_CAGR40 = "Return\nquintile", 
										Return_Range = "Range of 40-year\ncompound return")

tab_ERC_PV_3rows
save_as_image(tab_ERC_PV_3rows, path = here::here("Outputs_Analysis/tab_ERC_PV_3rows.png"))


```




```{r tab_ERC_vol1, echo = FALSE}

fun_sum <- median
# fun_sum <- mean

df_tab_ERC_vol1 <- 
df_ERCMaxChg %>% 
	select(runname, sim, ERC_PR_chg5yMax) %>% 
	mutate(ERC_PR_chg5yMax = 100 * ERC_PR_chg5yMax) %>% 
	left_join(df_CAGR40, by = "sim") %>% 
	group_by(runname, grp_CAGR40) %>% 
	summarise(ERC_PR_chg5yMax_med = fun_sum(ERC_PR_chg5yMax)) %>% 
  arrange(runname, desc(grp_CAGR40)) %>% 
	filter(runname %in% runnames_show1) %>% 
	spread(runname, ERC_PR_chg5yMax_med) %>% 
	# kable(digits = 1, caption = "Max 5-year ERC change in 40-year CAGR groups, starting FR=75%", format = 'pandoc')
	gather(policy, value, -grp_CAGR40) %>% 
	mutate(policy = factor(policy, levels = c(runnames_show1),
												         labels = c(runnames_show1_labels)),
												 ) %>% 
	spread(policy, value) %>% 
	mutate(Return_Range = grp_CAGR40_labels) %>% 
	select(grp_CAGR40, Return_Range, everything()) 


tab_ERC_vol1 <- 
  df_tab_ERC_vol1 %>% 
	# filter(grp_CAGR40 %in% c(1, 3, 5)) %>% 
	flextable() %>%
	add_header_row(values = "Maximum increase in employer contribution rate in 5 years by long-term return quintile\n(Median values within groups)", 
								 colwidths = 7) %>% 
	# autofit() %>% 
	height(part = "body",   height = .6) %>%
	height(part = "header", i = 2, height = 1) %>%
	height(part = "header", i = 1, height = .7) %>%
	hrule(rule = "exact", part = "all") %>%
	bg(part = "header", i = 2, bg = "gray90") %>% 
	fontsize(size = 14, part = "all") %>% 
	fontsize(size = 18, part = "header", i = 1) %>% 
	width(j = 1, width = 0.8) %>%
	width(j = 2, width = 1.8) %>%
	set_header_labels(grp_CAGR40 = "Return\nquintile", 
										Return_Range = "Range of 40-year\ncompound return") %>% 
	align(j = 1:2, align = "center", part = "all")  %>% 
	width(j = 3:7, width = 1.4) %>% 
	colformat_num(j = 3:7, digits = 1, suffix = "%") 
tab_ERC_vol1


save_as_image(tab_ERC_vol1, path = here::here("Outputs_Analysis/tab_ERC_vol1.png"))


tab_ERC_vol1_3rows <- 
  df_tab_ERC_vol1 %>% 
	filter(grp_CAGR40 %in% c(1, 3, 5)) %>% 
	flextable() %>%
	add_header_row(values = "Maximum increase in employer contribution rate in 5 years by long-term return quintile\n(Median values within groups)", 
								 colwidths = 7) %>% 
	# autofit() %>% 
	height(part = "body",   height = .6) %>%
	height(part = "header", i = 2, height = 1) %>%
	height(part = "header", i = 1, height = .7) %>%
	hrule(rule = "exact", part = "all") %>%
	bg(part = "header", i = 2, bg = "gray90") %>% 
	fontsize(size = 14, part = "all") %>% 
	fontsize(size = 18, part = "header", i = 1) %>% 
	width(j = 1, width = 0.8) %>%
	width(j = 2, width = 1.8) %>%
	set_header_labels(grp_CAGR40 = "Return\nquintile", 
										Return_Range = "Range of 40-year\ncompound return") %>% 
	align(j = 1:2, align = "center", part = "all")  %>% 
	width(j = 3:7, width = 1.4) %>% 
	colformat_num(j = 3:7, digits = 1, suffix = "%") 
tab_ERC_vol1_3rows


save_as_image(tab_ERC_vol1_3rows, path = here::here("Outputs_Analysis/tab_ERC_vol1_3rows.png"))

```



```{r tab_ERC_vol2, echo = FALSE}

df_ERC_hike <-  
  results_stch_FR75 %>% 
	as_tibble() %>% 
	select(runname, sim, year, ERC_PR) %>% 
	group_by(runname, sim) %>% 
	mutate(ERC_hike = cumany( ERC_PR - lag(ERC_PR, 5, Inf) > 0.1) ) %>% 
	group_by(runname, year) %>% 
	summarise(ERC_hike = sum(ERC_hike)/n())


tab_ERC_vol2 <- 
df_ERC_hike %>% 
	filter(runname %in% runnames_show1, year %in% c(10, 20)) %>% 
	spread(runname, ERC_hike) %>% 
	# kable(digits = 2, caption = "Probability of ERC rate rising more than 10% \nwithin a 5-year period in the first 10 or 20 years", format = "pandoc")
	gather(policy, value, -year) %>% 
	
  mutate(policy = factor(policy, levels = c(runnames_show1),
												         labels = c(runnames_show1_labels)),
				 value = value * 100) %>% 
	spread(policy, value) %>% 
	
	flextable() %>%
	add_header_row(values = "Probability of employer contribution rate rising more than 10% \nwithin a 5-year period in the first 10 or 20 years", 
								 colwidths = 6) %>% 
	# autofit() %>% 
	height(part = "body",   height = .6) %>%
	height(part = "header", i = 1, height = .8) %>%
	height(part = "header", i = 2, height = 1) %>%
	hrule(rule = "exact", part = "all") %>%
	bg(part = "header", i = 2, bg = "gray90") %>% 
	width(j = 1, width = 0.8) %>%
	width(j = 2:6, width = 1.4) %>%
	fontsize(size = 14, part = "all") %>% 
	fontsize(size = 18, part = "header", i = 1) %>% 
	# autofit(add_w = 1) %>% 
	align(j = 1, align = "center", part = "all")  %>% 
	colformat_num(j = 2:6, digits = 1, suffix = "%") %>% 
	set_header_labels(year = "Up to year"
									   )
tab_ERC_vol2

save_as_image(tab_ERC_vol2, path = here::here("Outputs_Analysis/tab_ERC_vol2.png"))
	
```





```{r tab_B_PV1, echo=FALSE}

df_benefit_PV <- 
	df_benefit_y1 %>% 
	summarise(runname_wlabel = unique(runname_wlabel),
						# B_PV_dr    = sum(B * fct_dr),
						B_PV_tot    = sum(B* fct_dr * fct_qxm),
						B_PV_tot_drLow   = sum(B* fct_dr_low * fct_qxm)
	)


df_PVB_sim2sim_grp <- 
  df_benefit_PV %>% 
	select(-runname_wlabel) %>% 
	left_join(filter(df_benefit_PV, runname == "baseline") %>% ungroup %>% 
							select(sim, B_PV_tot_baseline = B_PV_tot, B_PV_tot_drLow_baseline = B_PV_tot_drLow), by = "sim") %>% 
	left_join(df_CAGR40, by = "sim") %>% 
	mutate(
		     #ERC_PV          = 100 * ERC_PV / df_PVC_sim2sim$baseline[df_PVC_sim2sim$Percentile == "ptile50"],
				 #ERC_PV_baseline = 100 * ERC_PV_baseline / df_PVC_sim2sim$baseline[df_PVC_sim2sim$Percentile == "ptile50"],
		     B_PV_tot_diff     = B_PV_tot - B_PV_tot_baseline,
				 B_PV_tot_diff_pct = 100*( B_PV_tot / B_PV_tot_baseline - 1),
				 
				 B_PV_tot_drLow_diff     = B_PV_tot_drLow - B_PV_tot_drLow_baseline,
				 B_PV_tot_drLow_diff_pct = 100*( B_PV_tot_drLow / B_PV_tot_drLow_baseline - 1)
				 )
	
fun_sum <- median
# fun_sum <- mean

df_PVB_sim2sim_grp %<>% 
	group_by(runname, grp_CAGR40) %>% 
	summarise(B_PV_tot          = fun_sum(B_PV_tot),
						B_PV_tot_diff     = fun_sum(B_PV_tot_diff),
						B_PV_tot_diff_pct = fun_sum(B_PV_tot_diff_pct),
						
						B_PV_tot_drLow          = fun_sum(B_PV_tot_drLow),
						B_PV_tot_drLow_diff     = fun_sum(B_PV_tot_drLow_diff),
						B_PV_tot_drLow_diff_pct = fun_sum(B_PV_tot_drLow_diff_pct)
						) %>% 
  arrange(runname, desc(grp_CAGR40))


df_tab_B_PV1 <- 
df_PVB_sim2sim_grp %>% 
	select(runname, grp_CAGR40, B_PV_tot_diff_pct) %>% 
	filter(runname %in% runnames_show2) %>% 
	ungroup() %>% 
	mutate(runname = factor(runname, levels = runnames_show2)) %>% 
	spread(runname, B_PV_tot_diff_pct) %>% 
	select(-baseline) %>% 
	left_join(df_PVB_sim2sim_grp %>% 
							filter(runname == "baseline") %>% 
							ungroup() %>% 
	            select(grp_CAGR40, B_PV_tot),
						by = "grp_CAGR40"
						) %>% 
	select(baseline_PVB = B_PV_tot, everything()) %>% 
	# kable(digits = 1, caption = "Median percentage difference from baseline by return group (%), DR = 7.5%", format = 'pandoc')
	gather(policy, value, -grp_CAGR40) %>% 
	mutate(policy = factor(policy, levels = c("baseline_PVB", runnames_show2),
												         labels = c("PV benefit\nin Baseline", runnames_show2_labels)),
												 ) %>% 
	spread(policy, value) %>% 
	mutate(Return_Range = grp_CAGR40_labels) %>% 
	select(grp_CAGR40, Return_Range, everything())
	
tab_B_PV1 <- 
  df_tab_B_PV1 %>% 
	flextable() %>%
	add_header_row(values = "Percentage differences in PV benefit from baseline\nby long-term return quintile\n(Median values within groups)", 
								 colwidths = 6) %>% 
	# autofit() %>% 
	height(part = "body",   height = .6) %>%
	height(part = "header", i = 2, height = 1) %>%
	height(part = "header", i = 1, height = .8) %>%
	hrule(rule = "exact", part = "all") %>%
	bg(part = "header", i = 2, bg = "gray90") %>% 
	width(j = 1, width = 0.8) %>%
	width(j = 2, width = 1.8) %>%
	width(j = 3:6, width = 1.5) %>%
	fontsize(size = 14, part = "all") %>% 
	fontsize(size = 18, part = "header", i = 1) %>% 
	# autofit(add_w = 1) %>% 
	align(j = 1:2, align = "center", part = "all")  %>% 
	colformat_num(j = 4:6, digits = 1, suffix = "%") %>% 
	colformat_num(j = 3, digits = 0) %>% 
	set_header_labels(grp_CAGR40 = "Return\nquintile", 
										Return_Range = "Range of 40-year\ncompound return")

tab_B_PV1
save_as_image(tab_B_PV1, path = here::here("Outputs_Analysis/tab_B_PV1.png"))


tab_B_PV1_3rows <- 
  df_tab_B_PV1 %>% 
	filter(grp_CAGR40 %in% c(1, 3, 5)) %>% 
	flextable() %>%
	add_header_row(values = "Percentage differences in PV benefit from baseline\nby long-term return quintile\n(Median values within groups)", 
								 colwidths = 6) %>% 
	# autofit() %>% 
	height(part = "body",   height = .6) %>%
	height(part = "header", i = 2, height = 1) %>%
	height(part = "header", i = 1, height = .8) %>%
	hrule(rule = "exact", part = "all") %>%
	bg(part = "header", i = 2, bg = "gray90") %>% 
	width(j = 1, width = 0.8) %>%
	width(j = 2, width = 1.8) %>%
	width(j = 3:6, width = 1.5) %>%
	fontsize(size = 14, part = "all") %>% 
	fontsize(size = 18, part = "header", i = 1) %>% 
	# autofit(add_w = 1) %>% 
	align(j = 1:2, align = "center", part = "all")  %>% 
	colformat_num(j = 4:6, digits = 1, suffix = "%") %>% 
	colformat_num(j = 3, digits = 0) %>% 
	set_header_labels(grp_CAGR40 = "Return\nquintile", 
										Return_Range = "Range of 40-year\ncompound return")

tab_B_PV1_3rows
save_as_image(tab_B_PV1_3rows, path = here::here("Outputs_Analysis/tab_B_PV1_3rows.png"))



```





```{r tab_B_PV2, echo=FALSE}

df_benefit_PV <- 
	df_benefit_y1 %>% 
	summarise(runname_wlabel = unique(runname_wlabel),
						# B_PV_dr    = sum(B * fct_dr),
						B_PV_tot    = sum(B* fct_dr * fct_qxm),
						B_PV_tot_drLow   = sum(B* fct_dr_low * fct_qxm)
	)

df_low_pvB <- 
df_benefit_PV %>% 
	left_join(filter(df_benefit_PV, runname == "cola_full") %>% 
							ungroup %>%  select(sim, B_PV_tot_full = B_PV_tot), by = "sim") %>% 
  left_join(filter(df_benefit_PV, runname == "baseline") %>% 
  						ungroup %>%  select(sim, B_PV_tot_baseline = B_PV_tot), by = "sim") %>% 
	mutate(dif_full     = B_PV_tot / B_PV_tot_full,
				 dif_baseline = B_PV_tot / B_PV_tot_baseline
				 ) %>% 
	group_by(runname) %>% 
	summarise(Low_pvB_full_pct90     = 100 * sum(dif_full     <= 0.9)/n(),
						Low_pvB_baseline_pct90 = 100 * sum(dif_baseline <= 0.9)/n(),
						
						Low_pvB_full_pct95     = 100 * sum(dif_full     <= 0.95)/n(),
						Low_pvB_baseline_pct95 = 100 * sum(dif_baseline <= 0.95)/n(),
						)

tab_B_PV2 <- 
df_low_pvB %>% 
	filter(runname %in% runnames_show2) %>% 
	select(runname, contains("Low_pvB_baseline")) %>% 
	mutate(runname = factor(runname, levels = runnames_show2)) %>% 
	gather(Measure, value, -runname) %>% 
	spread(runname, value) %>% 
	# kable(digits = 1, caption = "Probability (%) of PV benefit below 90%/95% of that in baseline (cola = 1.5%)", format = 'pandoc')
  gather(policy, value, -Measure) %>% 
	mutate(policy = factor(policy, levels = c(runnames_show2),
												         labels = c(runnames_show2_labels)),
				 
				 Measure = factor(Measure, levels = c("Low_pvB_baseline_pct90", "Low_pvB_baseline_pct95"),
				 								           labels = c("Lower than 90% of Baseline", "Lower than 95% of Baseline")
				 								                     ),
				 value = value
												 ) %>% 
	spread(policy, value) %>% 
	select(-Baseline) %>% 
  flextable() %>%
	add_header_row(values = "Probability of present value of benefit below 90% or 95% of the level in baseline", 
								 colwidths = 4) %>% 
	# autofit() %>% 
	height(part = "body",   height = .6) %>%
	height(part = "header", i = 2, height = 1) %>%
	height(part = "header", i = 1, height = .8) %>%
	hrule(rule = "exact", part = "all") %>%
	bg(part = "header", i = 2, bg = "gray90") %>% 
	width(j = 1, width = 2) %>%
	width(j = 2:4, width = 1.5) %>%
	fontsize(size = 14, part = "all") %>% 
	fontsize(size = 18, part = "header", i = 1) %>% 
	# autofit(add_w = 1) %>% 
	align(j = 1, align = "center", part = "all")  %>% 
	colformat_num(j = 2:4, digits = 1, suffix = "%") %>% 
	#colformat_num(j = 3, digits = 0) %>% 
	set_header_labels(Measure = "Measure")

tab_B_PV2
	
save_as_image(tab_B_PV2, path = here::here("Outputs_Analysis/tab_B_PV2.png"))

```





```{r tab_B_vol2, echo = FALSE}


fun_sum <- median

df_tab_B_vol1 <- 
df_benefit_y1 %>% 
  summarise(B_real_chg5yMin = min(B_real_chg5y, na.rm = TRUE),
						B_real_age80   = B_real[age == 80]) %>% 
	left_join(df_CAGR40, by = "sim") %>% 
	group_by(runname, grp_CAGR40) %>% 
	summarise(B_real_chg5yMin_med = fun_sum(B_real_chg5yMin)) %>% 
	arrange(runname, desc(grp_CAGR40)) %>% 
	filter(runname %in% runnames_show2) %>% 
	ungroup() %>% 
	mutate(runname = factor(runname, levels = runnames_show2)) %>% 
	spread(runname, B_real_chg5yMin_med) %>% 
	# kable(digits = 1, caption = "Max 5-year decrease in benefit by 40-year CAGR group, starting FR=75%", format = 'pandoc')

	gather(policy, value, -grp_CAGR40) %>% 
	mutate(policy = factor(policy, levels = c("baseline", runnames_show2),
												         labels = c("Baseline", runnames_show2_labels)),
												 ) %>% 
	spread(policy, value) %>% 
	mutate(Return_Range = grp_CAGR40_labels) %>% 
	select(grp_CAGR40, Return_Range, everything()) 
	

tab_B_vol1 <-  
	df_tab_B_vol1 %>% 
	flextable() %>%
	add_header_row(values = "Maximum 5-year decreases in real benefit by long-term return quintile\n(Median values within groups)", 
								 colwidths = 6) %>% 
	# autofit() %>% 
	height(part = "body",   height = .6) %>%
	height(part = "header", i = 2, height = 1) %>%
	height(part = "header", i = 1, height = .7) %>%
	hrule(rule = "exact", part = "all") %>%
	bg(part = "header", i = 2, bg = "gray90") %>% 
	fontsize(size = 14, part = "all") %>% 
	fontsize(size = 18, part = "header", i = 1) %>% 
	width(j = 1, width = 0.8) %>%
	width(j = 2, width = 1.8) %>%
	set_header_labels(grp_CAGR40 = "Return\nquintile", 
										Return_Range = "Range of 40-year\ncompound return") %>% 
	align(j = 1:2, align = "center", part = "all")  %>% 
	width(j = 3:6, width = 1.5) %>% 
	colformat_num(j = 3:6, digits = 1, suffix = "%") 

tab_B_vol1
save_as_image(tab_B_vol1, path = here::here("Outputs_Analysis/tab_B_vol1.png"))



tab_B_vol1_3rows <-  
	df_tab_B_vol1 %>% 
	filter(grp_CAGR40 %in% c(1, 3, 5)) %>% 
	flextable() %>%
	add_header_row(values = "Maximum 5-year decreases in real benefit by long-term return quintile\n(Median values within groups)", 
								 colwidths = 6) %>% 
	# autofit() %>% 
	height(part = "body",   height = .6) %>%
	height(part = "header", i = 2, height = 1) %>%
	height(part = "header", i = 1, height = .7) %>%
	hrule(rule = "exact", part = "all") %>%
	bg(part = "header", i = 2, bg = "gray90") %>% 
	fontsize(size = 14, part = "all") %>% 
	fontsize(size = 18, part = "header", i = 1) %>% 
	width(j = 1, width = 0.8) %>%
	width(j = 2, width = 1.8) %>%
	set_header_labels(grp_CAGR40 = "Return\nquintile", 
										Return_Range = "Range of 40-year\ncompound return") %>% 
	align(j = 1:2, align = "center", part = "all")  %>% 
	width(j = 3:6, width = 1.5) %>% 
	colformat_num(j = 3:6, digits = 1, suffix = "%") 

tab_B_vol1_3rows
save_as_image(tab_B_vol1_3rows, path = here::here("Outputs_Analysis/tab_B_vol1_3rows.png"))





```

```{r, tab_B_vol2, echo = FALSE}

df_B_low <- 
df_benefit_y1 %>% 
	as_tibble() %>% 
	select(runname, runname_wlabel, sim, year, B_real) %>% 
	group_by(runname, sim) %>% 
	mutate(B_lower90 = cumany(B_real < 90)) %>% 
	group_by(runname, year) %>% 
	summarise(B_lower90 = sum(B_lower90) /n())


tab_B_vol2 <- 
df_B_low %>% 
	filter(runname %in% runnames_show2, year %in% c(10, 20)) %>% 
	ungroup() %>% 
	mutate(runname = factor(runname, levels = runnames_show2)) %>% 
	spread(runname, B_lower90) %>% 
	# kable(digits = 3, caption = "Probability of real benefit falling below 90% of starting benefit \nin any year up to year 10 and 20", format = "pandoc") %>% 
  gather(policy, value, -year) %>% 
	mutate(policy = factor(policy, levels = c(runnames_show2),
												         labels = c(runnames_show2_labels)),
				 value = 100 * value
												 ) %>% 
	spread(policy, value) %>% 
	flextable() %>%
	add_header_row(values = "Probability of real benefit falling below 90% \nof starting benefit in any year up to year 10 or 20", 
								 colwidths = 5) %>% 
	# autofit() %>% 
	height(part = "body",   height = .6) %>%
	height(part = "header", i = 2, height = 1) %>%
	height(part = "header", i = 1, height = .7) %>%
	hrule(rule = "exact", part = "all") %>%
	bg(part = "header", i = 2, bg = "gray90") %>% 
	fontsize(size = 14, part = "all") %>% 
	fontsize(size = 18, part = "header", i = 1) %>% 
	align(j = 1, align = "center", part = "all")  %>% 
	width(j = 1, width = .8) %>%
	width(j = 2:5, width = 1.5) %>% 
	colformat_num(j = 2:5, digits = 1, suffix = "%") %>% 
	set_header_labels(year = "Up to year") 
tab_B_vol2 	
	

save_as_image(tab_B_vol2, path = here::here("Outputs_Analysis/tab_B_vol2.png"))



```





