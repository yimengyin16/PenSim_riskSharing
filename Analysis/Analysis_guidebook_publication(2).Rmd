---
title: "Preparation for Policy Guidebook"
output: 
  html_notebook: 
    number_sections: yes
    toc: yes
    fig_caption: yes
editor_options: 
  chunk_output_type: console
---

```{r Global_settings, include=FALSE}

## Loading packages
source(here::here("libraries.R"))

theme_set(theme_yy())

dir_modelResults <- paste0(here::here(),"/Outputs/")
dir_outputs      <- paste0(here::here(),"/Analysis/figTbl_guidebook_publication/") 


# Global parameters for analysis
dr     <- 0.075 # discount rate
dr_low <- 0.03  # lower discount rate
infl   <- 0.02  # assumed inflation rate
# Nyear  <- 40    # Number of sim years for contribution analysis
cola_baseline <- 0.015

DC_EECrate <- 0.025
DC_ERCrate <- 0.028

```

```{r Loading_results, include = FALSE}

source(here::here("Analysis_loadingResults.R"))
# Outputs: 
   # results_all
   # run_labels
```

# Color scheme
```{r}


red_dark   <- "#a7233a"
green_dark <- "#00664e"  #"#006b3c"  #
blue_dark  <- "#034ea2"

red_light   <- "#e48191" #70% brightness
green_light <- "#00cc9c" #40% brightness
blue_light  <- "#69aefc" #70% brightness


colors_6 <- c(blue_light, blue_dark, 
							green_light, green_dark, 
							red_light, red_dark)

```




# Preparation

## CAGR

```{r quintiles, echo = FALSE, warning=FALSE}

# Grouping variables

## Grouping by 40-year compound return 

# Dividing simulations into 5 groups based 40-year CAGR, difference in ERC rate:
#    1) 90th percentile and above []
#    2) 75th~90th percentile [)
#    3) 25th~75th percentile [)
#    4) 25th percentile and below [)
# Grouping can be done based on other variables (e.g. std of return)

get_CAGR <- function(df, span){

# span <- 40
	
df_CAGR <- 
results_all %>% 
	filter(runname == "baseline", sim >= 1, year <= span) %>% 
	group_by(sim) %>% 
	summarise(CAGR = get_geoReturn(i.r)) 
  #summarise(CAGR40 = sd(i.r)) 

grpVals_CAGR <-
	df_CAGR %>% 
	summarise(CAGR_pinf= Inf,
		        CAGR_q80 = quantile(CAGR, 0.80),
						CAGR_q60 = quantile(CAGR, 0.60),
						CAGR_q50 = quantile(CAGR, 0.50),
						CAGR_q40 = quantile(CAGR, 0.40),
						CAGR_q20 = quantile(CAGR, 0.20),
						CAGR_ninf= -Inf,
	) 

grpVals_CAGR_vector <- unlist(grpVals_CAGR[1,2:6])

df_CAGR %<>% 
	mutate(
		grp_CAGR = cut(CAGR, unlist(grpVals_CAGR[1,])[-4], label = F )
	)


#fn <- function(x){paste0(round(x * 100, 1), "%")}
fn <- function(x){paste0(sprintf("%.1f",x*100), "%")}



cutoff <- c(
	paste0("< ", fn(grpVals_CAGR_vector[5])),
	paste0(fn(grpVals_CAGR_vector[5]), "~" ,fn(grpVals_CAGR_vector[4])),
	paste0(fn(grpVals_CAGR_vector[4]), "~" ,fn(grpVals_CAGR_vector[2])),
	paste0(fn(grpVals_CAGR_vector[2]), "~" ,fn(grpVals_CAGR_vector[1])),
	paste0("> ", fn(grpVals_CAGR_vector[1]))
)

# cutoff

list(df     = df_CAGR, 
		 cutoff = cutoff)
}

# df_CAGR80 <- get_CAGR(results_all, 80)
df_CAGR40 <- get_CAGR(results_all, 40)
df_CAGR30 <- get_CAGR(results_all, 30)
df_CAGR15 <- get_CAGR(results_all, 15)
df_CAGR26 <- get_CAGR(results_all, 26)

```



## Analysis of ERC
```{r ERC_prep, echo=FALSE, warning=FALSE}

## PV ERC and EEC 
get_PVC <- function(df, span, dr = 0.075){

  df %>% 
	filter(year <= span) %>% 
	select(runname, runname_wlabel, sim, year, policy_type, ERC, EEC, UAAL) %>% 
	group_by(runname, sim) %>% 
	summarise(
		        runname_wlabel = unique(runname_wlabel),
						
		        # PV of ERC
		        ERC_PV         = sum(ERC / (1 + dr)^(year - 1)),
						ERCwUAAL_PV    = sum(ERC / (1 + dr)^(year - 1)) + UAAL[year == max(year)] / (1 + unique(dr))^(max(year) - 1),
						
						# PV of EEC
						EEC_PV         = sum(EEC / (1 + dr)^(year - 1))
						)
}

#df_PVC_30y <- get_PVC(results_all, 30)
df_PVC_15y <- get_PVC(results_all, 15)



## Percentiles of PVC for each policy
get_PVC_qtiles <- function(df_PVC){

# df_PVC_qtiles <- 
	df_PVC %>% 
	filter(sim >= 1) %>% 
	summarise(runname_wlabel = unique(runname_wlabel),
						
						ERC_PV_q90 = quantile(ERC_PV, 0.90),
						ERC_PV_q75 = quantile(ERC_PV, 0.75),
						ERC_PV_q50 = quantile(ERC_PV, 0.50),
						ERC_PV_q25 = quantile(ERC_PV, 0.25),
						ERC_PV_q10 = quantile(ERC_PV, 0.1),
						
						ERCwUAAL_PV_q90 = quantile(ERCwUAAL_PV, 0.90, na.rm = TRUE),
						ERCwUAAL_PV_q75 = quantile(ERCwUAAL_PV, 0.75, na.rm = TRUE),
						ERCwUAAL_PV_q50 = quantile(ERCwUAAL_PV, 0.50, na.rm = TRUE),
						ERCwUAAL_PV_q25 = quantile(ERCwUAAL_PV, 0.25, na.rm = TRUE),
						ERCwUAAL_PV_q10 = quantile(ERCwUAAL_PV, 0.1,  na.rm = TRUE),
						
						EEC_PV_q90 = quantile(EEC_PV, 0.90),
						EEC_PV_q75 = quantile(EEC_PV, 0.75),
						EEC_PV_q50 = quantile(EEC_PV, 0.50),
						EEC_PV_q25 = quantile(EEC_PV, 0.25),
						EEC_PV_q10 = quantile(EEC_PV, 0.1)
						)
}

#df_PVC_qtiles_30y <- get_PVC_qtiles(df_PVC_30y)
df_PVC_qtiles_15y <- get_PVC_qtiles(df_PVC_15y)



## Maximum increase in ERC rate WITHIN 5 years
# Note:
#  - Need to take into account the possibility that the changes in less then 5 years
#    are greater than the 5-year change. The method below takes care of this. 

get_ERCMaxChg <- function(df, span){

df_ERCMaxChg <- 		
  df %>% 
  filter(sim >= 1, year <= span) %>% 
	select(runname, runname_wlabel, sim, year, policy_type, ERC_PR) %>%
	group_by(runname, sim) %>% 
	mutate(   ERC_PR_chg5y    = rollapply(ERC_PR, width = 6, get_nyearMax, fill = NA, align = "right")) %>% # zoo::rollapply
	summarise(runname_wlabel = unique(runname_wlabel),
		        ERC_PR_chg5yMax = max(ERC_PR_chg5y, na.rm = TRUE))
	
  df_ERCMaxChg_qtile <- 
	df_ERCMaxChg %>% 
	summarise(runname_wlabel = unique(runname_wlabel),
						
						ERC_PR_chg5yMax_q90 = quantile(ERC_PR_chg5yMax, 0.90),
						ERC_PR_chg5yMax_q75 = quantile(ERC_PR_chg5yMax, 0.75),
						ERC_PR_chg5yMax_q50 = quantile(ERC_PR_chg5yMax, 0.50),
						ERC_PR_chg5yMax_q25 = quantile(ERC_PR_chg5yMax, 0.25),
						ERC_PR_chg5yMax_q10 = quantile(ERC_PR_chg5yMax, 0.1)
						)	
  
  list(
  	ERCMaxChg = df_ERCMaxChg,
  	ERCMaxChg_qtile = df_ERCMaxChg_qtile
  )
}

#df_ERCMaxChg_30y <- get_ERCMaxChg(results_all, 30)
df_ERCMaxChg_15y <- get_ERCMaxChg(results_all, 15)



## Maximum increase in EEC rate WITHIN 5 years
get_EECMaxChg <- function(df, span){

df_EECMaxChg <- 		
  df %>% 
  filter(sim >= 1, year <= span) %>% 
	select(runname, runname_wlabel, sim, year, policy_type, EEC_PR) %>%
	group_by(runname, sim) %>% 
	mutate(EEC_PR_chg5y    = rollapply(EEC_PR, width = 6, get_nyearMax, fill = NA, align = "right")) %>% # zoo::rollapply
	summarise(runname_wlabel = unique(runname_wlabel),
		        EEC_PR_chg5yMax = max(EEC_PR_chg5y, na.rm = TRUE))
	
  df_EECMaxChg_qtile <- 
	df_EECMaxChg %>% 
	summarise(runname_wlabel = unique(runname_wlabel),
						
						EEC_PR_chg5yMax_q90 = quantile(EEC_PR_chg5yMax, 0.90),
						EEC_PR_chg5yMax_q75 = quantile(EEC_PR_chg5yMax, 0.75),
						EEC_PR_chg5yMax_q50 = quantile(EEC_PR_chg5yMax, 0.50),
						EEC_PR_chg5yMax_q25 = quantile(EEC_PR_chg5yMax, 0.25),
						EEC_PR_chg5yMax_q10 = quantile(EEC_PR_chg5yMax, 0.1)
						)	
  
  list(
  	EECMaxChg = df_EECMaxChg,
  	EECMaxChg_qtile = df_EECMaxChg_qtile
  )
}

#df_EECMaxChg_30y <- get_EECMaxChg(results_all, 30)
df_EECMaxChg_15y <- get_EECMaxChg(results_all, 15)





```



## Analysis of benefit
```{r benefit_prep, include = FALSE}

# Cohorts to examine:
	# Cohort 1: Retired at age 60 in year 1 (1 - 41)
	# Cohort 2: Retired at age 60 in year 15 (15- 55)
		#  - After the 15-year amortization period for the year-1 UAAL 

# Normalize the benefit at age 60 to 100. 
# Need qxm.r in decrement table 

load("Inputs/riskShaing_demographics_100y.RData")


get_benefit <- function(df, start_year, span = 41){


#start_year <- 1
#span       <- 41

if(span < 21) stop("span must be no less than 21")
if(max(results_all$year) < start_year + span - 1) stop("Time span exceeds the max year in data.")


## Create a model run with cola_actual = infl and append to results_all
df_colaFull <- 
  #results_all %>% 
  df %>% 
	filter(runname == "baseline") %>% 
	mutate(cola_actual = infl,
				 runname     = "cola_full")

## df of annual benefit payments and discount factors
df_benefit <- 
	bind_rows(df, df_colaFull) %>% 
	filter(year %in% (start_year + seq_len(span) - 1)) %>% 
	select(runname, runname_wlabel, policy_type, sim, year, cola_actual) %>% 
	group_by(runname, sim) %>% 
	mutate(age = seq_len(span) - 1 + 60 ) %>% 
	left_join(decrement %>% ungroup() %>% filter(ea == min(ea))  %>% select(age, qxm.r) , by = "age") %>% 
	mutate(qxm.r   = ifelse(age == max(age), 1, qxm.r),
				 fct_qxm = ifelse(age == 60, 1, lag(cumprod(1-qxm.r))),
				 fct_dr      = 1/(1 + dr)^(age - 60),
				 fct_dr_low  = 1/(1 + dr_low)^(age - 60),
				 B       = 100 * ifelse(age == 60, 1, lag(cumprod(1+cola_actual))),
				 B_real  = B / (1 + infl)^(age - 60),
				 B_real_chg5y = rollapply(B_real, width = 6, get_nyearMin, fill = NA, align = "right")
				 )


df_benefit_qtile <- 
	df_benefit %>%
	filter(sim >= 1) %>% 
	summarise(runname_wlabel = unique(runname_wlabel),
						B_PV_dr    = sum(B * fct_dr),
						B_PV_tot   = sum(B* fct_dr * fct_qxm),
						B_real_chg5yMin = min(B_real_chg5y, na.rm = TRUE),
						B_real_age80   = B_real[age == 80]		
	) %>% 
	summarise(runname_wlabel = unique(runname_wlabel),
						
						B_PV_dr_q90 = quantile(B_PV_dr, 0.90),
						B_PV_dr_q75 = quantile(B_PV_dr, 0.75),
						B_PV_dr_q50 = quantile(B_PV_dr, 0.50),
						B_PV_dr_q25 = quantile(B_PV_dr, 0.25),
						B_PV_dr_q10 = quantile(B_PV_dr, 0.1),
						
						B_PV_tot_q90 = quantile(B_PV_tot, 0.90),
						B_PV_tot_q75 = quantile(B_PV_tot, 0.75),
						B_PV_tot_q50 = quantile(B_PV_tot, 0.50),
						B_PV_tot_q25 = quantile(B_PV_tot, 0.25),
						B_PV_tot_q10 = quantile(B_PV_tot, 0.1),
						
						B_real_chg5yMin_q90 = quantile(B_real_chg5yMin, 0.90),
						B_real_chg5yMin_q75 = quantile(B_real_chg5yMin, 0.75),
						B_real_chg5yMin_q50 = quantile(B_real_chg5yMin, 0.50),
						B_real_chg5yMin_q25 = quantile(B_real_chg5yMin, 0.25),
						B_real_chg5yMin_q10 = quantile(B_real_chg5yMin, 0.1),
						
						B_real_age80_q90 = quantile(B_real_age80, 0.90),
						B_real_age80_q75 = quantile(B_real_age80, 0.75),
						B_real_age80_q50 = quantile(B_real_age80, 0.50),
						B_real_age80_q25 = quantile(B_real_age80, 0.25),
						B_real_age80_q10 = quantile(B_real_age80, 0.1)
						)

list(
	benefit       = df_benefit,
	benefit_qtile = df_benefit_qtile 
)

}

#df_benefit_y41  <- get_benefit(results_all, start_year = 1, span = 41)
df_benefit_y26  <- get_benefit(results_all, start_year = 1, span = 26)

```




# Figures for stochastic runs


## Distribution of pvERC - fig5
```{r}

# Use df_PVC_qtiles_15/30y generated in section "Analysis ERC"

df_PVC_qtiles_y15_plot <- 
  df_PVC_qtiles_15y %>% 
	mutate_at(vars(-runname,-runname_wlabel), ~ 100 *./df_PVC_qtiles_15y$ERC_PV_q50[df_PVC_qtiles_15y$runname == "baseline"]) %>% 
	select(runname, contains("ERC_PV")) 
   

runnames_ERC <- c(
   	baseline                 = "Baseline",
		
		cola_returnSmooth_calib2     = "Contingent\nCOLA:\n5-year return",
		cola_FR_calib                = "Contingent\nCOLA:\nfunded ratio",
		
		EEC_returnSmooth         = "Contingent\nEEC:\n5-year return",
		EEC_FR_t100              = "Contingent\nEEC:\nfunded ratio",
		
		EEC_sharedADCcap         = "Shared ADC:\n 10% EEC cap",  
		EEC_sharedADC            = "Shared ADC:\n no EEC cap", 
		
		hybrid_DB_noLegacy       = "Hybrid \nDB-DC",
		cola_SDRS                = "SDRS-like",
		DA_as                    = "Conditional \nindexation"
)



df_PVC_qtiles_plot <- df_PVC_qtiles_y15_plot 
nyear_pvERC <- 15

fig_title    <- paste0("Distributions of the present value of ", nyear_pvERC, "-year employer contributions (ERC) \nunder different risk-sharing policies") 
 
fig5_dist_pvERC_y15_all <- 
  df_PVC_qtiles_plot %>% 
  filter(runname %in% names(runnames_ERC)) %>% 
	mutate(runname = factor(runname, levels = names(runnames_ERC), 
													         labels = runnames_ERC)) %>% 
	filter(runname != "SDRS-like") %>% 
	ggplot(aes(x = runname)) + 
	geom_boxplot(width = 0.4,
							 stat = "identity",
							 aes(ymin   = ERC_PV_q10,
							 	 	lower   = ERC_PV_q25,
							 		middle  = ERC_PV_q50,
							 		upper   = ERC_PV_q75,
							 		ymax    = ERC_PV_q90)) + 
	geom_hline(yintercept =
						 filter(df_PVC_qtiles_plot, runname == "baseline") %>% pull(ERC_PV_q50),
						 linetype = 2) +
  geom_vline(xintercept = c(1.5, 5.5), linetype = 3, color = "grey60", size = 1) + 	
  annotate("text", x = 3.5, y = 175, label = "Policies with modest adjustments to \ndefined-benefit plans") + 
  annotate("text", x = 7.5, y = 175, label = "More-radical or more-complex\nrisk-sharing policies")	+
	
  coord_cartesian(ylim = c(0, 180)) + 
	scale_y_continuous(breaks = seq(0, 300, 20)) + 
	labs(title = fig_title,
			 subtitle = NULL,# fig_subtitle,
			 x = NULL, 
			 y = "Present value of ERC") 
 
fig5_dist_pvERC_y15_all
save_figure(fig5_dist_pvERC_y15_all, dir_outputs, w = 11, h = 7, scale = 0.85)


```


## Distribution of max ERC increase - fig6
```{r}

df_ERCvol_qtiles_plot <- df_ERCMaxChg_15y$ERCMaxChg_qtile
#nyear <- 15

# SDRS-like included
fig_title    <- paste0("Maximum 5-year increase in employer contribution (ERC) rate over 15 years\n(75th percentile)")
fig_dist_ERCvol_y15_barplot <- 
  df_ERCvol_qtiles_plot %>% 
  filter(runname %in% names(runnames_ERC)) %>% 
	mutate(runname = factor(runname, levels = names(runnames_ERC), 
													         labels = runnames_ERC)) %>% 
	ggplot(aes(x = runname, y)) + 
	geom_bar(aes(y = ERC_PR_chg5yMax_q75), 
					 stat = "identity",
					 width = 0.5,
					 fill = RIG.blue) + 
	geom_hline(yintercept =
						 filter(df_ERCvol_qtiles_plot, runname == "baseline") %>% pull(ERC_PR_chg5yMax_q75),
						 linetype = 2) +
  geom_vline(xintercept = c(1.5, 5.5), linetype = 3, color = "grey60", size = 1) + 	
  annotate("text", x = 3.5, y = 0.17, label = "Policies with modest adjustments to \ndefined-benefit plans") + 
  
	annotate("text", x = 8, y = 0.17, label = "More-radical or more-complex\nrisk-sharing policies")	+
	
  coord_cartesian(ylim = c(0, 0.18)) + 
	scale_y_continuous(breaks = seq(0, 1, 0.05), labels =  function(x) percent(x, accuracy = 1)) + 
	labs(title = fig_title,
			 subtitle = NULL,# fig_subtitle,
			 x = NULL, 
			 y = "Increase in ERC as a percentage of payroll") 
 
fig_dist_ERCvol_y15_barplot
# save_figure(fig_dist_ERCvol_y15_barplot, dir_outputs, w = 11, h = 7, scale = 0.85)


# SDRS-like excluded
fig_title    <- paste0("Maximum 5-year increase in employer contribution (ERC) rate over 15 years\n(75th percentile)")
fig6_dist_ERCvol_y15_barplot2 <- 
  df_ERCvol_qtiles_plot %>% 
  filter(runname %in% names(runnames_ERC)) %>% 
	mutate(runname = factor(runname, levels = names(runnames_ERC), 
													         labels = runnames_ERC)) %>% 
	filter(runname != "SDRS-like") %>% 
	ggplot(aes(x = runname, y)) + 
	geom_bar(aes(y = ERC_PR_chg5yMax_q75), 
					 stat = "identity",
					 width = 0.5,
					 fill = blue_dark) + 
	geom_hline(yintercept =
						 filter(df_ERCvol_qtiles_plot, runname == "baseline") %>% pull(ERC_PR_chg5yMax_q75),
						 linetype = 2) +
  geom_vline(xintercept = c(1.5, 5.5), linetype = 3, color = "grey60", size = 1) + 	
  annotate("text", x = 3.5, y = 0.17, label = "Policies with modest adjustments to \ndefined-benefit plans") + 
  
	annotate("text", x = 8, y = 0.17, label = "More-radical or more-complex\nrisk-sharing policies")	+
	
  coord_cartesian(ylim = c(0, 0.18)) + 
	scale_y_continuous(breaks = seq(0, 1, 0.05), labels =  function(x) percent(x, accuracy = 1)) + 
	labs(title = fig_title,
			 subtitle = NULL,# fig_subtitle,
			 x = NULL, 
			 y = "Increase in ERC as a percentage of payroll") 
 
fig6_dist_ERCvol_y15_barplot2
save_figure(fig6_dist_ERCvol_y15_barplot2, dir_outputs, w = 11, h = 7, scale = 0.85)


# fig_dist_ERCvol_y15_barplot2_ppt <- fig_dist_ERCvol_y15_barplot2
# save_figure(fig_dist_ERCvol_y15_barplot2_ppt, dir_outputs, w = 11, h = 7, scale = 0.75)

```


## Distribution of 40-year COLA- fig7

```{r}


runnames_colaDist <- c(
	baseline                 = "Baseline",
		
	cola_returnSmooth_calib2  = "Contingent COLA:\n5-year return",
	cola_FR_calib            = "Contingent COLA:\nfunded ratio\nYear-1 funded ratio 75%",
	cola_FR_calib_FR100      = "Contingent COLA:\nfunded ratio\nYear-1 funded ratio 100%"
	
	#cola_SDRS                = "SDRS-like",
	#cola_SDRS_FR100          = "SDRS-like \nYear-1 funded ratio 100%"
	#DA_as                    = "Conditional \nindexation"
	)



get_colaDist <- function(df, start_year, span = 40){

# start_year = 1
# span = 40

year_span <- start_year + seq_len(span) - 1


# Distribution of 40-year COLA
df_cola <- 
	results_all %>% 
	filter(year %in% year_span) %>% 
	# filter(year %in% 16:55) %>% 
	filter(sim >= 1, runname %in% names(runnames_colaDist) ) %>% 
	group_by(runname, sim) %>%
	summarise(runname_wlabel = unique(runname_wlabel),
						cola_avg  = prod(1 + cola_actual[-n()])^(1/(n() - 1)) - 1)


df_cola_qtiles <- 
	df_cola %>% 
	summarise(runname_wlabel = unique(runname_wlabel),
						cola_avg_q10 = quantile(cola_avg, 0.1),
						cola_avg_q25 = quantile(cola_avg, 0.25),
						cola_avg_q50 = quantile(cola_avg, 0.50),
						cola_avg_q75 = quantile(cola_avg, 0.75),
						cola_avg_q90 = quantile(cola_avg, 0.90)
						)

fig_title    <- "Distributions of 40-year compound annual COLA \nunder different COLA policies"
fig_subtitle <- paste0("For members who retire in year ", start_year)
fig_cola_qtiles_calib <- 
	df_cola_qtiles %>% 
	mutate(runname = factor(runname, levels = names(runnames_colaDist) ,
													         labels = runnames_colaDist)) %>% 
	ggplot(aes(x = runname)) + 
	geom_boxplot(width = 0.3,
							 stat = "identity",
							 aes(ymin   = cola_avg_q10,
							 		lower  = cola_avg_q25,
							 		middle = cola_avg_q50,
							 		upper  = cola_avg_q75,
							 		ymax   = cola_avg_q90)
	) + 
	geom_hline(yintercept =
						 filter(df_cola_qtiles, runname == "baseline") %>% pull(cola_avg_q50),
						 linetype = 2) +
	coord_cartesian(ylim = c(0, 0.025)) + 
	scale_y_continuous(breaks = seq(0, 1, 0.005), labels = function(x) percent(x, accuracy = 0.1)) + 
	labs(title = fig_title,
			 subtitle = fig_subtitle,
			 x = NULL, 
			 y = "Compound annual COLA")
fig_cola_qtiles_calib

list(
	df_qtiles = df_cola_qtiles,
	fig = fig_cola_qtiles_calib
)

}


fig_colaDist <- get_colaDist(results_all, start_year = 1)

fig7_colaDist <- fig_colaDist$fig
save_figure(fig7_colaDist, dir_outputs, w = 11, h = 7, scale = 0.8)

```


## Distribution of pv benefit - fig8
```{r}

runnames_pvB <- c(
	baseline                 = "Baseline",
		
	cola_returnSmooth_calib2  = "Contingent COLA:\n5-year return",
	cola_FR_calib            = "Contingent COLA:\nfunded ratio\nYear-1 funded ratio 75%",
	cola_FR_calib_FR100      = "Contingent COLA:\nfunded ratio\nYear-1 funded ratio 100%"
	
	#cola_SDRS                = "SDRS-like",
	#cola_SDRS_FR100          = "SDRS-like \nYear-1 funded ratio 100%"
	#DA_as                    = "Conditional \nindexation"
	)


fig_title    <- paste0("Distribution of the present value of benefit up to age 85 \nunder different risk-sharing policies")
fig_subtitle <- "Benefit at age 60 normalized to 100"
fig_dist_pvB_y26 <- 
  df_benefit_y26$benefit_qtile%>% 
  filter(runname %in% names(runnames_pvB)) %>% 
	mutate(runname = factor(runname, levels = names(runnames_pvB), 
													         labels = runnames_pvB)) %>% 
	ggplot(aes(x = runname)) + 
	geom_boxplot(width = 0.3,
							 stat = "identity",
							 aes(ymin   = B_PV_dr_q10,
							 	 	lower   = B_PV_dr_q25,
							 		middle  = B_PV_dr_q50,
							 		upper   = B_PV_dr_q75,
							 		ymax    = B_PV_dr_q90)) + 
	# geom_hline(yintercept =
	# 					 filter(df_PVC_qtiles_plot, runname == "baseline") %>% pull(ERC_PV_q50),
	# 					 linetype = 2) +
  # geom_vline(xintercept = c(1.5, 5.5), linetype = 3, color = "grey60", size = 1) + 	
#   annotate("text", x = 3.5, y = 0.18, label = "Policies with modest adjustments to \ndefined-benefit plans") + 
#   
# 	annotate("text", x = 8, y = 0.18, label = "More-complex \nrisk-sharing policies")	+
	
  coord_cartesian(ylim = c(1200, 1550)) + 
	scale_y_continuous(breaks = seq(0, 5000, 100), labels = comma) + 
	labs(title = fig_title,
			 subtitle = fig_subtitle,# fig_subtitle,
			 x = NULL, 
			 y = "Present value of benefit") 
 
fig_dist_pvB_y26
# save_figure(fig_dist_pvB_y26, dir_outputs, w = 11, h = 7, scale = 0.8)



fig_title    <- paste0("Distribution of the present value of benefit up to age 85 \nunder different risk-sharing policies")
fig_subtitle <- "The present value under Baseline is normalized to 100"


B_PV_std <- df_benefit_y26$benefit_qtile[1, 5] %>% unlist

fig8_dist_pvB_y26_std <- 
  df_benefit_y26$benefit_qtile%>% 
  filter(runname %in% names(runnames_pvB)) %>% 
	mutate(runname = factor(runname, levels = names(runnames_pvB), 
													         labels = runnames_pvB)) %>% 
	mutate(across(c(-runname, -runname_wlabel), ~.x / B_PV_std * 100) ) %>% 
	ggplot(aes(x = runname)) + 
	geom_boxplot(width = 0.3,
							 stat = "identity",
							 aes(ymin   = B_PV_dr_q10,
							 	 	lower   = B_PV_dr_q25,
							 		middle  = B_PV_dr_q50,
							 		upper   = B_PV_dr_q75,
							 		ymax    = B_PV_dr_q90)) + 
	# geom_hline(yintercept =
	# 					 filter(df_PVC_qtiles_plot, runname == "baseline") %>% pull(ERC_PV_q50),
	# 					 linetype = 2) +
  # geom_vline(xintercept = c(1.5, 5.5), linetype = 3, color = "grey60", size = 1) + 	
#   annotate("text", x = 3.5, y = 0.18, label = "Policies with modest adjustments to \ndefined-benefit plans") + 
#   
# 	annotate("text", x = 8, y = 0.18, label = "More-complex \nrisk-sharing policies")	+
	
  coord_cartesian(ylim = c(85, 110)) + 
	scale_y_continuous(breaks = seq(0, 500, 5)) + 
	labs(title = fig_title,
			 subtitle = fig_subtitle,# fig_subtitle,
			 x = NULL, 
			 y = "Present value of benefit") 
 
fig8_dist_pvB_y26_std
save_figure(fig8_dist_pvB_y26_std, dir_outputs, w = 11, h = 7, scale = 0.8)

```

## Distribution of pvEEC - fig9

```{r}

# Use df_PVC_qtiles_15/30y generated in section "Analysis ERC"

df_pvEEC_qtiles_y15_plot <- 
  df_PVC_qtiles_15y %>% 
	mutate_at(vars(-runname,-runname_wlabel), ~ 100 *./df_PVC_qtiles_15y$EEC_PV_q50[df_PVC_qtiles_15y$runname == "baseline"]) %>% 
	select(runname, contains("EEC_PV")) 
   

runnames_EEC <- c(
   	baseline                 = "Baseline",
		
		#cola_returnSmooth_calib2     = "Contingent\nCOLA:\n5-year return",
		# cola_returnSmooth_calib2_s10 = "Contingent COLA:\n10-year return",
		#cola_FR_calib                = "Contingent\nCOLA:\nfunded ratio",
		
		EEC_returnSmooth         = "Contingent\nEEC:\n5-year return",
		# EEC_FR                   = "Contingent EEC:\nfunded ratio threshold 85%",
		EEC_FR_t100              = "Contingent\nEEC:\nfunded ratio",
		
		EEC_sharedADCcap         = "Shared ADC:\n 10% EEC cap",  
		EEC_sharedADC            = "Shared ADC:\n no EEC cap",
		
		#hybrid_DB                = "Hybrid \nDB-DC",
		#hybrid_DB_noLegacy       = "Hybrid \nDB-DC",
		cola_SDRS                = "SDRS-like"
		#DA_as                    = "Conditional \nindexation"
		
)



df_pvEEC_qtiles_plot <- df_pvEEC_qtiles_y15_plot
nyear_pvEEC <- 15

fig_title    <- paste0("Distributions of the present value of ", nyear_pvEEC, "-year employee contributions (EEC) \nunder different risk-sharing policies") 
 
fig9_dist_pvEEC_y15_all <- 
  df_pvEEC_qtiles_plot %>% 
  filter(runname %in% names(runnames_EEC)) %>% 
	mutate(runname = factor(runname, levels = names(runnames_EEC), 
													         labels = runnames_EEC)) %>% 
	filter(runname != "SDRS-like") %>% 
	ggplot(aes(x = runname)) + 
	geom_boxplot(width = 0.35,
							 stat = "identity",
							 aes(ymin   = EEC_PV_q10,
							 	 	lower   = EEC_PV_q25,
							 		middle  = EEC_PV_q50,
							 		upper   = EEC_PV_q75,
							 		ymax    = EEC_PV_q90)) + 
	geom_hline(yintercept =
						 filter(df_pvEEC_qtiles_plot, runname == "baseline") %>% pull(EEC_PV_q50),
						 linetype = 2) +
  geom_vline(xintercept = c(1.5, 3.5), linetype = 3, color = "grey60", size = 1) + 	
  annotate("text", x = 2.5, y = 315, label = "Policies with \nmodest adjustments to \ndefined-benefit plans") + 
  annotate("text", x = 4.5, y = 315, label = "More-radical or more-complex\nrisk-sharing policies")	+
	
  coord_cartesian(ylim = c(0, 330)) + 
	scale_y_continuous(breaks = seq(0, 500, 50)) + 
	labs(title = fig_title,
			 subtitle = NULL,# fig_subtitle,
			 x = NULL, 
			 y = "Present value of EEC") 
 
fig9_dist_pvEEC_y15_all
save_figure(fig9_dist_pvEEC_y15_all, dir_outputs, w = 11, h = 7, scale = 0.85)


```



## Distribution of max EEC increase - fig10

```{r}

df_EECvol_qtiles_plot <- df_EECMaxChg_15y$EECMaxChg_qtile

fig_title    <- paste0("Maximum 5-year increase in employee contribution rate over 15 years\n(75th percentile)")
fig_dist_EECvol_y15_barplot <- 
  df_EECvol_qtiles_plot %>% 
  filter(runname %in% names(runnames_EEC)) %>% 
	mutate(runname = factor(runname, levels = names(runnames_EEC), 
													         labels = runnames_EEC)) %>% 
	ggplot(aes(x = runname, y)) + 
	geom_bar(aes(y = EEC_PR_chg5yMax_q75), 
					 stat = "identity",
					 width = 0.5,
					 fill = RIG.blue) + 
	geom_hline(yintercept =
						 filter(df_EECvol_qtiles_plot, runname == "baseline") %>% pull(EEC_PR_chg5yMax_q75),
						 linetype = 2) +  


  geom_vline(xintercept = c(1.5, 3.5), linetype = 3, color = "grey60", size = 1) + 	
  annotate("text", x = 2.5, y = 0.17, label = "Policies with \nmodest adjustments to \ndefined-benefit plans") + 
  
	annotate("text", x = 5, y = 0.17, label = "More-radical and more-complex \nrisk-sharing policies")	+
	
  coord_cartesian(ylim = c(0, 0.18)) + 
	scale_y_continuous(breaks = seq(0, 1, 0.05), labels =  function(x) percent(x, accuracy = 1)) + 
	labs(title = fig_title,
			 subtitle = NULL,# fig_subtitle,
			 x = NULL, 
			 y = "Increase in EEC as a percentage of payroll") 
 
fig_dist_EECvol_y15_barplot
# save_figure(fig_dist_EECvol_y15_barplot, dir_outputs, w = 11, h = 7, scale = 0.85)



fig_title <- paste0("Maximum 5-year increase in employee contribution (EEC) rate over 15 years\n(75th percentile)")
fig10_dist_EECvol_y15_barplot2 <- 
  df_EECvol_qtiles_plot %>% 
  filter(runname %in% names(runnames_EEC)) %>% 
	mutate(runname = factor(runname, levels = names(runnames_EEC), 
													         labels = runnames_EEC)) %>% 
	filter(runname != "SDRS-like") %>% 
	ggplot(aes(x = runname, y)) + 
	geom_bar(aes(y = EEC_PR_chg5yMax_q75), 
					 stat = "identity",
					 width = 0.5,
					 fill = blue_dark) + 
	geom_hline(yintercept =
						 filter(df_EECvol_qtiles_plot, runname == "baseline") %>% pull(EEC_PR_chg5yMax_q75),
						 linetype = 2) +  


  geom_vline(xintercept = c(1.5, 3.5), linetype = 3, color = "grey60", size = 1) + 	
  annotate("text", x = 2.5, y = 0.072, label = "Policies with \nmodest adjustments to \ndefined-benefit plans") + 
  
	annotate("text", x = 4.5, y = 0.072, label = "More-radical and more-complex \nrisk-sharing policies")	+
	
  coord_cartesian(ylim = c(0, 0.08)) + 
	scale_y_continuous(breaks = seq(0, 1, 0.02), labels =  function(x) percent(x, accuracy = 1)) + 
	labs(title = fig_title,
			 subtitle = NULL,# fig_subtitle,
			 x = NULL, 
			 y = "Increase in EEC as a percentage of payroll") 

fig10_dist_EECvol_y15_barplot2
save_figure(fig10_dist_EECvol_y15_barplot2, dir_outputs, w = 11, h = 7, scale = 0.8)

```




# Fitures for asset-shock runs
## Asset shock: ERC rate - fig2
```{r eval=FALSE}

## Deterministic asset shock scenarios:

# sim -1: starting FR = 100%
# sim -2: starting FR = 75%

df_assetShock <- 
	results_all %>% 
	filter(sim < 0)


runnames_shock <- c(
   	baseline                 = "Baseline",
		
		cola_returnSmooth_calib2     = "Contingent COLA:\n5-year return",
		# cola_returnSmooth_calib2_s10 = "Contingent COLA:\n10-year return",
		cola_FR_calib                = "Contingent COLA:\nfunded ratio",
		
		EEC_returnSmooth         = "Contingent EEC:\n5-year return",
		# EEC_FR                   = "Contingent EEC:\nfunded ratio threshold 85%",
		EEC_FR_t100              = "Contingent EEC:\nfunded ratio",
		
		EEC_sharedADCcap         = "Shared ADC:\n 10% EEC cap",  
		EEC_sharedADC            = "Shared ADC:\n no EEC cap"
		
		#hybrid_DB                = "Hybrid \nDB-DC",
		#hybrid_DB_noLegacy       = "Hybrid \nDB-DC",
		#cola_SDRS                = "SDRS-like"
		#DA_as                    = "Conditional \nindexation"
)


df_assetShock_plot <- 
  df_assetShock %>% 
	filter(sim == -2, year <=20, runname %in% names(runnames_shock)) %>% # sim -2: 75% starting FR
	mutate(SC_PR = SC / PR) %>% 
	select(runname, sim, year,ERC, ERC_PR, FR_MA, NC_PR, EEC_PR, SC_PR, cola_actual) %>% 
	mutate(runname = factor(runname, names(runnames_shock)),
				 runname_label = factor(runname, labels = runnames_shock))

# df_assetShock_plot %>% 
# 	filter(runname == "cola_returnSmooth_calib2")
# 	
# df_assetShock_plot %>% 
# 	filter(runname == "cola_FR_calib")
# 
# df_assetShock_plot %>% 
# 	filter(runname == "EEC_sharedADC")


## ERC plot for policy guidebook


# Plotting ERC rate  

colors_brewer <- brewer_pal(type = "qual", palette = "Paired")(8)
colors_plot   <- colors_6
colors_plot[c(3,4)] <- colors_brewer[c(3,4)]

colors_plot <- c("black", colors_plot)


df_assetShock_plot %<>% 
	mutate(pts_size = ifelse(runname == "baseline" & year >=10, 2.5, 2))


fig_title <- "Employer contribution rates after the asset shock\nunder different risk-sharing policies"

fig2_shock_ERCpaper <- 
  df_assetShock_plot %>% 
	filter(year <= 15,
				 runname %in% names(runnames_shock)[(1:8)]) %>% 
	mutate(Alpha = ifelse(runname %in% runnames_shock[(1)], 1, 0)) %>% 
	ggplot(aes(x = year, y = ERC_PR, color = runname_label)) +
	geom_line(size = 1) + 
	#geom_point(size = 2) + 
	geom_point(aes(size = pts_size))+
	annotate("rect", xmin = 2, xmax = 3, ymin = -1, ymax = 1, fill = "red", size = 0, alpha = 0.1) +
	annotate("rect", xmin = 3, xmax = 6, ymin = -1, ymax = 1, fill = "yellow", size = 0, alpha = 0.1) +
	annotate("text", x = 2.5, y = 0.29, label = "Asset\nshock\n(-24%)", color = "grey40") +
	annotate("text", x = 4.5, y = 0.29, label = "Recovery\n(12% annually)", color = "grey40") +
	annotate("text", x = 11, y = 0.29, label = "Post-recovery\n(7.5% annually)", color = "grey40") +
  coord_cartesian(ylim = c(0, 0.3))	+
	scale_x_continuous(breaks = seq(0, 100, 1)) +
	scale_y_continuous(breaks = seq(0, 1, 0.05), labels = function(x) percent(x, accuracy = 1)) +
	#scale_color_manual(values = c("black", brewer_pal(type = "qual", palette = "Paired")(8) )) +
  scale_color_manual(values = colors_plot) + 
	scale_size_continuous(range = c(2, 3.5), guide = FALSE) +
	scale_alpha_continuous(range = c(0.15,1), guide = FALSE) +
	labs(title = fig_title,
		   x = "Year",
			 y = "Employer contribution rate",
			 color = "Policy") +
  guides(color = guide_legend(keywidth = 1.5, keyheight = 2.5),
				 shape = guide_legend(keywidth = 1.5, keyheight = 2.5)
				 )
fig2_shock_ERCpaper


save_figure(fig2_shock_ERCpaper, fig_folder = dir_outputs, scale = 0.95, w = 10, h = 6, dpi =400)
```




## Asset shock: EEC rate - fig4
```{r eval=FALSE}

## Deterministic asset shock scenarios:

# sim -1: starting FR = 100%
# sim -2: starting FR = 75%

df_assetShock <- 
	results_all %>% 
	filter(sim < 0)


runnames_shock <- c(
   	baseline                 = "Baseline",
		
		# cola_returnSmooth_calib2     = "Contingent COLA:\n5-year return",
		# cola_returnSmooth_calib2_s10 = "Contingent COLA:\n10-year return",
		# cola_FR_calib                = "Contingent COLA:\nfunded ratio",
		
		EEC_returnSmooth         = "Contingent EEC:\n5-year return",
		# EEC_FR                   = "Contingent EEC:\nfunded ratio threshold 85%",
		EEC_FR_t100              = "Contingent EEC:\nfunded ratio",
		
		EEC_sharedADCcap         = "Shared ADC:\n 10% EEC cap",  
		EEC_sharedADC            = "Shared ADC:\n no EEC cap"
		
		#hybrid_DB                = "Hybrid \nDB-DC",
		#hybrid_DB_noLegacy       = "Hybrid \nDB-DC",
		#cola_SDRS                = "SDRS-like"
		#DA_as                    = "Conditional \nindexation"
)


df_assetShock_plot <- 
  df_assetShock %>% 
	filter(sim == -2, year <=20, runname %in% names(runnames_shock)) %>% # sim -2: 75% starting FR
	mutate(SC_PR = SC / PR) %>% 
	select(runname, sim, year,ERC, ERC_PR, FR_MA, NC_PR, EEC_PR, SC_PR, cola_actual) %>% 
	mutate(runname = factor(runname, names(runnames_shock)),
				 runname_label = factor(runname, labels = runnames_shock))

# df_assetShock_plot %>% 
# 	filter(runname == "cola_returnSmooth_calib2")
# 	
# df_assetShock_plot %>% 
# 	filter(runname == "cola_FR_calib")
# 
# df_assetShock_plot %>% 
# 	filter(runname == "EEC_sharedADC")


## ERC plot for policy guidebook


# Plotting ERC rate  

# colors_plot <- brewer_pal(type = "qual", palette = "Paired")(8)


df_assetShock_plot %<>% 
	mutate(pts_size = ifelse(runname == "baseline" & year >=11, 2.5, 2))


fig_title <- "Employee contribution rates after the asset shock\nunder different risk-sharing policies"

fig4_shock_EECpaper <- 
  df_assetShock_plot %>% 
	filter(year <= 15,
				 runname %in% names(runnames_shock)[(1:5)]) %>% 
	mutate(Alpha = ifelse(runname %in% runnames_shock[(1)], 1, 0)) %>% 
	ggplot(aes(x = year, y = EEC_PR, color = runname_label)) +
	geom_line(size = 1) + 
	# geom_point(size = 2) + 
	geom_point(aes(size = pts_size))+
	annotate("rect", xmin = 2, xmax = 3, ymin = -1, ymax = 1, fill = "red", size = 0, alpha = 0.1) +
	annotate("rect", xmin = 3, xmax = 6, ymin = -1, ymax = 1, fill = "yellow", size = 0, alpha = 0.1) +
	annotate("text", x = 2.5, y = 0.19, label = "Asset\nshock\n(-24%)", color = "grey40") +
	annotate("text", x = 4.5, y = 0.19, label = "Recovery\n(12% annually)", color = "grey40") +
	annotate("text", x = 11, y = 0.19, label = "Post-recovery\n(7.5% annually)", color = "grey40") +
  coord_cartesian(ylim = c(0, 0.2))	+
	scale_x_continuous(breaks = seq(0, 100, 1)) +
	scale_y_continuous(breaks = seq(0, 1, 0.05), labels = function(x) percent(x, accuracy = 1)) +
	# scale_color_manual(values = c("black", brewer_pal(type = "qual", palette = "Paired")(8)[3:6] )) +
	scale_color_manual(values = colors_plot[c(1, 4:7)]) +
  scale_alpha_continuous(range = c(0.15,1), guide = FALSE) +
	scale_size_continuous(range = c(2, 3.5), guide = FALSE) +
	labs(title = fig_title,
		   x = "Year",
			 y = "Employee contribution rate",
			 color = "Policy") +
  guides(color = guide_legend(keywidth = 1.5, keyheight = 2.5),
				 shape = guide_legend(keywidth = 1.5, keyheight = 2.5)
				 )
fig4_shock_EECpaper


save_figure(fig4_shock_EECpaper, fig_folder = dir_outputs, scale = 0.95, w = 10, h = 6, dpi =400)
```



## Asset shock: real benefit - fig3

```{r eval=FALSE}


load("Inputs/riskShaing_demographics_100y.RData")

runnames_shock_ben <- c(
   	baseline                 = "Baseline",
		
		cola_returnSmooth_calib2     = "Contingent COLA:\n5-year return",
		# cola_returnSmooth_calib2_s10 = "Contingent COLA:\n10-year return",
		cola_FR_calib                = "Contingent COLA:\nfunded ratio"
		
		#cola_FR_calib_FR100          = "Contingent\nCOLA:\nfunded ratio\n 100%"
		
		#EEC_returnSmooth         = "Contingent\nEEC:\n5-year return",
		# EEC_FR                   = "Contingent EEC:\nfunded ratio threshold 85%",
		#EEC_FR_t100              = "Contingent\nEEC:\nfunded ratio",
		
		#EEC_sharedADCcap         = "shared ADC\n 10% EEC cap",  
		#EEC_sharedADC            = "shared ADC\n no EEC cap"
		
		#hybrid_DB                = "Hybrid \nDB-DC",
		#hybrid_DB_noLegacy       = "Hybrid \nDB-DC",
		#cola_SDRS                = "SDRS-like"
		#DA_as                    = "Conditional \nindexation"
)



df_benefit_det <- 
	results_all %>% 
	filter(sim == -2, year %in% 1:41) %>% 
	select(runname, policy_type, sim, year, cola_actual) %>% 
	group_by(runname, sim) %>% 
	mutate(age = 60:100) %>% 
	mutate(
				 B       = 100 * ifelse(age == 60, 1, lag(cumprod(1+cola_actual))),
				 B_real  = B / (1 + infl)^(age - 60)
				 ) %>% 
	filter(runname %in% names(runnames_shock_ben), year <= 15) %>% 
	ungroup() %>% 
	mutate(runname = factor(runname, levels = names(runnames_shock_ben)),
				 runname_label = factor(runname, labels = runnames_shock_ben))



fig_title <- "Inflation-adjusted annual benefits after the asset shock\nunder different risk-sharing policies"
fig_subtitle <- "Benefit in year 1 = 100"

fig3_shock_realB <- 
df_benefit_det %>% 
	filter(runname %in% names(runnames_shock_ben)[1:4]) %>% 
	ggplot(aes(x = year, y = B_real, color = runname_label)) +
	geom_line(size = 1) + 
	geom_point(size = 2) + 
	annotate("rect", xmin = 2, xmax = 3, ymin = -Inf, ymax = Inf, fill = "red", size = 0, alpha = 0.1) +
	annotate("rect", xmin = 3, xmax = 6, ymin = -Inf, ymax = Inf, fill = "yellow", size = 0, alpha = 0.1) +
	annotate("text", x = 2.5, y = 105, label = "Asset\nshock\n(-24%)", color = "grey40") +
	annotate("text", x = 4.5, y = 105, label = "Recovery\n(12% annually)", color = "grey40") +
  annotate("text", x = 11, y = 105, label = "Post-recovery\n(7.5% annually)", color = "grey40") +
	coord_cartesian(ylim = c(60, 107))	+
	scale_x_continuous(breaks = seq(0, 100, 1)) + 
	scale_y_continuous(breaks = seq(0, 200, 10)) +
	# scale_color_manual(values = c("black", brewer_pal(type = "qual", palette = "Paired")(4) ))+
	scale_color_manual(values = colors_plot[c(1:3)]) +
  scale_alpha_continuous(range = c(0.1,1), guide = FALSE) + 
	#scale_size_continuous(range = c(2, 3.5), guide = FALSE) +
	labs(title = fig_title,
			 subtitle = fig_subtitle,
		   x = "Year",
			 y = "Real annual benefit ",
			 color = "Policy") + 
  guides(color = guide_legend(keywidth = 1.5, keyheight = 2.5),
				 shape = guide_legend(keywidth = 1.5, keyheight = 2.5)
				 )
	
fig3_shock_realB
save_figure(fig3_shock_realB, fig_folder = dir_outputs, scale = 0.95, w = 10, h = 6, dpi =400)



# results_all %>% 
# 	filter(sim == 0, runname == "EEC_sharedADC")


```




```{r}

results_all %>% 
	filter(runname %in% c("cola_returnSmooth_calib2", "cola_FR_calib"), sim == -3, year <=17) %>% 
	select(runname, sim, year, FR_MA, cola_actual)



# cola_returnSmooth_calib2 = "Contingent COLA:\n5-year return",
# 		cola_returnSmooth_calib2_s10 = "Contingent COLA:\n10-year return",
# 		cola_FR_calib            = "Contingent COLA:\nfunded ratio 100%",

```




