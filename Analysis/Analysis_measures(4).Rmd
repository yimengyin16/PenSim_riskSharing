---
title: "Analysis of simulation results of pension risk-sharing"
output: 
  html_notebook: 
    number_sections: yes
    toc: yes
    fig_caption: yes
editor_options: 
  chunk_output_type: inline
---


# Notes

Notes on measures
https://docs.google.com/document/d/1oi2UEfcrsk6359-zbJTb8DamtbpoEGUFLzcY19njwUI/edit


```{r Global_settings, include=FALSE}

## Loading packages
source(here::here("libraries.R"))

theme_set(theme_yy())

#dir_modelResults <- paste0(here::here(),"/Outputs/")
dir_modelResults <- paste0(here::here(),"/Outputs_500sims/")
dir_outputs      <- paste0(here::here(),"/Outputs_Analysis/") 


# Global parameters for analysis
dr    <- 0.075 # discount rate
infl  <- 0.02  # assumed inflation rate
Nyear <- 40    # Number of sim years for contribution analysis
cola_baseline <- 0.015

DC_EECrate <- 0.025
DC_ERCrate <- 0.028

# run names for policy runs to show in results 
# policy_select <- c("baseline", "cola_return", "cola_FR", "EEC_sharedADCfloor", "EEC_return", "EEC_FR", "hybrid_DB")
runnames_show1 <- c("baseline", 
										
										"cola_return", 
										"cola_FR", 
							
										"EEC_return", 
										"EEC_FR", 
										"EEC_sharedADCfloor",
										
										"hybrid_DB")

runnames_show2 <- c("baseline", 
										
										"cola_return", 
										
										"cola_FR",
										"cola_FRramp",
										
										"cola_FR_FR100",
										"cola_FRramp_FR100"
										)



```

```{r Loading_results, include = FALSE}

source(here::here("Analysis_loadingResults.R"))
# Outputs: 
   # results_all
   # run_labels


```


# Analysis of ERC

 
**Q1. Overall cost reduction effects** 

**Question**: How large are the cost-reducing effects of common risk-sharing policies? What are the factors that affect the cost-reducing effects?

**Measures:**

* Sim-to-sim comparison of of PVC under baseline and PVC under risk sharing policy (40-year;valuated at year 1). Calculate the differences in PVC for each of the 2,000 simulations, and present the results at 5 percentiles of the baseline PVC (can be presented as differences in normalized dollar values or differences percentage).


* Sim-to-sim comparison of of PVC under baseline and PVC under risk sharing policy (40-year;valuated at year 1). Calculate the differences in PVC for each of the 2,000 simulations, and present average differences within 5 groups of 40-year CAGR. (can be presented as differences in normalized dollar values or differences percentage). 




<br><br/>


**Q2: Dampening effects on asset shock**

**Question**: To what extent risk-sharing policies can dampen the impact of large asset shocks on contributions?

**Measures**

* Probability of ERC rate rising by more than 10 percentage points within 5 years. This measures the the likelihood of large increases of ERC
* Max increase in ERC rate in 5 years. This measures the strength of the buffering effects when asset shock occurs.  
* Measure based on sim-to-sim comparison of ERC rate between baseline and risk-sharing policies 
* Examine ERC rate under a deterministic asset shock scenario similar to the Great Recession.  


<br><br/>

**Notes**

* Only look at runs starting with 75% funded ratio
* The parameters of the risk-sharing policies affect the impacts of their impacts. For each policy, have two runs with different risk-sharing parameters and compare the results.  
* Only present 1~3 measures for each question, can put other measures in appendix if necessary.  


```{r ERC_prep, echo = FALSE, warning=FALSE}

results_stch_FR75 <-  
  results_all %>% 
	filter(!str_detect(runname, "FR100")) %>% 
	filter(sim >= 1, year <= Nyear) 


## PV ERC and EEC 
df_PVC <- 
  results_stch_FR75 %>% 
	select(runname, runname_wlabel, sim, year, policy_type, ERC, EEC, UAAL) %>% 
	group_by(runname, sim) %>% 
	summarise(
		        runname_wlabel = unique(runname_wlabel),
						
		        # PV of ERC
		        ERC_PV         = sum(ERC / (1 + dr)^(year - 1)),
						ERCwUAAL_PV    = sum(ERC / (1 + dr)^(year - 1)) + UAAL[year == max(year)] / (1 + unique(dr))^(max(year) - 1),
						
						# PV of EEC
						EEC_PV         = sum(EEC / (1 + dr)^(year - 1))
						)


## Percentiles of PVC for each policy
df_PVC_qtiles <- 
	df_PVC %>% 
	summarise(runname_wlabel = unique(runname_wlabel),
						
						ERC_PV_q90 = quantile(ERC_PV, 0.90),
						ERC_PV_q75 = quantile(ERC_PV, 0.75),
						ERC_PV_q50 = quantile(ERC_PV, 0.50),
						ERC_PV_q25 = quantile(ERC_PV, 0.25),
						ERC_PV_q10 = quantile(ERC_PV, 0.1),
						
						ERCwUAAL_PV_q90 = quantile(ERCwUAAL_PV, 0.90),
						ERCwUAAL_PV_q75 = quantile(ERCwUAAL_PV, 0.75),
						ERCwUAAL_PV_q50 = quantile(ERCwUAAL_PV, 0.50),
						ERCwUAAL_PV_q25 = quantile(ERCwUAAL_PV, 0.25),
						ERCwUAAL_PV_q10 = quantile(ERCwUAAL_PV, 0.1),
						
						EEC_PV_q90 = quantile(EEC_PV, 0.90),
						EEC_PV_q75 = quantile(EEC_PV, 0.75),
						EEC_PV_q50 = quantile(EEC_PV, 0.50),
						EEC_PV_q25 = quantile(EEC_PV, 0.25),
						EEC_PV_q10 = quantile(EEC_PV, 0.1)
						)

# df_PVC_qtiles
# Why PV ERC of SDRS is so low, even with final UAAL?


## Sim-to-sim comparison of PVC at the same percentile PVC under baseline 

# find the sim# corresponding to percentiles of PVC under the baseline policy
ptiles <- c(ptile90 = 0.9, ptile75 = 0.75, ptile50 = 0.50, ptile25 = 0.25, ptile10 = 0.1)
nsim <- filter(df_PVC, runname == "baseline") %>% nrow()

df_PVC_sim2sim <- 
df_PVC %>% 
	select(runname, sim, ERC_PV) %>% 
	spread(runname, ERC_PV) %>% 
	arrange(desc(baseline)) %>% 
	mutate(sim_rank = 1:nsim) %>% 
	filter(sim_rank %in% round(nsim*ptiles)) %>% 
	mutate(ptile = names(ptiles),
				 var = "ERC_PV") %>% 
	select(var, ptile, everything(), -sim, -sim_rank)
	


# Dividing simulations into 5 groups based 40-year CAGR, difference in ERC rate:
#    1) 90th percentile and above []
#    2) 75th~90th percentile [)
#    3) 25th~75th percentile [)
#    4) 25th percentile and below [)
# Grouping can be done based on other variables (e.g. std of return)

df_CAGR40 <- 
results_all %>% 
	filter(runname == "baseline", sim >= 1) %>% 
	group_by(sim) %>% 
	summarise(CAGR40 = get_geoReturn(i.r)) 
  #summarise(CAGR40 = sd(i.r)) 

grpVals_CAGR40 <-
	df_CAGR40 %>% 
	summarise(CAGR40_pinf= Inf,
		        CAGR40_q90 = quantile(CAGR40, 0.90),
						CAGR40_q75 = quantile(CAGR40, 0.75),
						CAGR40_q50 = quantile(CAGR40, 0.50),
						CAGR40_q25 = quantile(CAGR40, 0.25),
						CAGR40_q10 = quantile(CAGR40, 0.10),
						CAGR40_ninf= -Inf,
	) 

#unlist(grpVals_CAGR40[1,])[-4] 
#df_CAGR40$CAGR40
#cut(df_CAGR40$CAGR40, unlist(grpVals_CAGR40[1,])[-4], label = F )

grpVals_CAGR40_vector <- unlist(grpVals_CAGR40[1,2:6])

df_CAGR40 %<>% 
	mutate(
		grp_CAGR40 = cut(CAGR40, unlist(grpVals_CAGR40[1,])[-4], label = F )
		# grp_CAGR40 = case_when(
		# CAGR40 >= grpVals_CAGR40$CAGR40_q90 ~ 1,
		# CAGR40 >= grpVals_CAGR40$CAGR40_q75 & CAGR40 < grpVals_CAGR40$CAGR40_q90 ~ 2,
		# CAGR40 >= grpVals_CAGR40$CAGR40_q25 & CAGR40 < grpVals_CAGR40$CAGR40_q75 ~ 3,
		# CAGR40 >= grpVals_CAGR40$CAGR40_q10 & CAGR40 < grpVals_CAGR40$CAGR40_q25 ~ 4,
		# CAGR40 < grpVals_CAGR40$CAGR40_q10 ~ 5,
		# TRUE ~ NA_real_) 
	)

# df_CAGR40


## Maximum increase in ERC rate WITHIN 5 years

# Note:
#  - Need to take into account the possibility that the changes in less then 5 years
#    are greater than the 5-year change. The method below takes care of this. 

# x <- filter(results_stch, sim ==1, runname == "cola_baseline") %>% pull("ERC_PR")
# zoo::rollapply(x, width = 6, get_nyearMax, fill = NA, align = "right")


df_ERCMaxChg <- 
	results_stch_FR75 %>% 
	select(runname, runname_wlabel, sim, year, policy_type, ERC_PR) %>%
	group_by(runname, sim) %>% 
	mutate(   ERC_PR_chg5y    = rollapply(ERC_PR, width = 6, get_nyearMax, fill = NA, align = "right")) %>% # zoo::rollapply
	summarise(runname_wlabel = unique(runname_wlabel),
		        ERC_PR_chg5yMax = max(ERC_PR_chg5y, na.rm = TRUE))

# df_ERCMaxChg


df_ERCMaxChg_qtile <- 
	df_ERCMaxChg %>% 
	summarise(runname_wlabel = unique(runname_wlabel),
						
						ERC_PR_chg5yMax_q90 = quantile(ERC_PR_chg5yMax, 0.90),
						ERC_PR_chg5yMax_q75 = quantile(ERC_PR_chg5yMax, 0.75),
						ERC_PR_chg5yMax_q50 = quantile(ERC_PR_chg5yMax, 0.50),
						ERC_PR_chg5yMax_q25 = quantile(ERC_PR_chg5yMax, 0.25),
						ERC_PR_chg5yMax_q10 = quantile(ERC_PR_chg5yMax, 0.1)
						)
# df_ERCMaxChg_qtile


# Proability of ERC rate rising by more than 5% in 40 years
```



## Overall cost reduction effect


**Measure 1**: Present value of ERC over 40 years compared to baseline (sim-to-sim): differences at PV ERC percentiles of baseline

Calculation:

- Adjust all values with the median PV ERC in baseline normalized to 100. 
- Calculate the difference in PV ERC between baseline and risk-sharing policies for each of the 2000 simulations.
- Find the sims corresponding to the PV ERC of baseline at 5 percentiles: 90, 75, 50, 25, 10. 
- Present the PVC differences of the sims above. 
- The differences are presented in (normalized) dollar values (second table below) and percentages (third table below) 


```{r, warning=FALSE, echo = FALSE}
# Try three different ways to present the differences in PVC

# 1. PVC with median result of baseline normalized to 100
df_PVC_sim2sim %>% 
	mutate_at(vars(-var, -ptile), ~ 100 * . / df_PVC_sim2sim$baseline[df_PVC_sim2sim$ptile == "ptile50"]) %>% 
	select(var, ptile, one_of(runnames_show1)) %>% 
	kable(digits = 1, caption = "Normalized PV ERC", format = "pandoc")

# 2. Based on 1, show dollar difference compared to baseline in the same row
df_PVC_sim2sim %>% 
	mutate_at(vars(-var, -ptile), ~ 100 * . / df_PVC_sim2sim$baseline[df_PVC_sim2sim$ptile == "ptile50"]) %>% 
	mutate_at(vars(-var, -ptile, -baseline), ~  . - baseline) %>% 
	select(var, ptile, one_of(runnames_show1)) %>% 
	kable(digits = 1, caption = "Dollar difference from the baseline in the same row", format = "pandoc")

	
# 3. Percentage difference compared to baseline in the same row
df_PVC_sim2sim %>% 
	mutate_at(vars(-var, -ptile, -baseline), ~  100*(./baseline - 1)) %>% 
	select(var, ptile, one_of(runnames_show1)) %>% 
	kable(digits = 1, caption = "Percentage difference from the baseline in the same row (%)", format = "pandoc")


```


**Measure 2**: Present value of ERC over 40 years compared to baseline: median differences in 5 return groups

Values in measure 1 are from single simulation runs, which may lead to irregular results due to randomness (the irregularity may be reduced when the number of sims increases). For measure 2, sims are divided into 5 groups by 40-year compound annual return, then we compare the median/mean differences in PV ERC in each group. Note that other grouping methods for sims may give difference results.    

The give groups and their ranges of compound average return are

- Group1: Lower than 10th percentile (`r round(grpVals_CAGR40_vector[5], 4)*100`%)
- Group2: 10th to 25th percentile (`r round(grpVals_CAGR40_vector[5], 4)*100`% to `r round(grpVals_CAGR40_vector[4], 4)*100`%)
- Group3: 25th to 75th percentile (`r round(grpVals_CAGR40_vector[4], 4)*100`% to `r round(grpVals_CAGR40_vector[2], 4)*100`%)
- Group4: 75th to 90th percentile (`r round(grpVals_CAGR40_vector[2], 4)*100`% to `r round(grpVals_CAGR40_vector[1], 4)*100`%)
- Group5: higher than 90th percentile (`r round(grpVals_CAGR40_vector[1], 4)*100`%)


```{r, warning=FALSE, echo = FALSE}
# Alternative measure: PVC differences in 5 CAGR groups 

df_PVC_sim2sim2 <-
	df_PVC %>% 
	select(runname, sim, ERC_PV) %>% 
	left_join(filter(df_PVC, runname == "baseline") %>% ungroup %>% select(sim, ERC_PV_baseline = ERC_PV), by = "sim" ) %>% 
  left_join(df_CAGR40, by = "sim") %>% 
	mutate(ERC_PV          = 100 * ERC_PV / df_PVC_sim2sim$baseline[df_PVC_sim2sim$ptile == "ptile50"],
				 ERC_PV_baseline = 100 * ERC_PV_baseline / df_PVC_sim2sim$baseline[df_PVC_sim2sim$ptile == "ptile50"],
		     ERC_PV_diff     = ERC_PV - ERC_PV_baseline,
				 ERC_PV_diff_pct = 100*( ERC_PV / ERC_PV_baseline - 1)
				 )

fun_sum <- median
# fun_sum <- mean

df_PVC_sim2sim2 %<>% 
	group_by(runname, grp_CAGR40) %>% 
	summarise(ERC_PV          = fun_sum(ERC_PV),
						ERC_PV_diff     = fun_sum(ERC_PV_diff),
						ERC_PV_diff_pct = fun_sum(ERC_PV_diff_pct),
						) %>% 
  arrange(runname, desc(grp_CAGR40))


# 
df_PVC_sim2sim2 %>% 
	select(runname, grp_CAGR40 , ERC_PV) %>% 
	spread(runname, ERC_PV) %>% 
	select(grp_CAGR40, one_of(runnames_show1)) %>% 
	kable(digits = 1, caption = "Median normalized PV ERC by return group", format = "pandoc")
  


df_PVC_sim2sim2 %>% 
	select(runname, grp_CAGR40 , ERC_PV_diff) %>% 
	spread(runname, ERC_PV_diff) %>% 
	select(grp_CAGR40, one_of(runnames_show1)) %>% 
  kable(digits = 1, caption = "Median dollar difference from baseline by return group", format = "pandoc")


df_PVC_sim2sim2 %>% 
	select(runname, grp_CAGR40 , ERC_PV_diff_pct) %>% 
	spread(runname, ERC_PV_diff_pct) %>% 
	select(grp_CAGR40, one_of(runnames_show1)) %>% 
  kable(digits = 1, caption = "Median percentage difference from baseline by return group (%)", format = "pandoc")





```



## Dampening effects on contribution volatility

**Measure 1** Measures the likelihood of large increases in ERC: Probability of ERC rate rising by more than 10 percentage points within 5 years. 


```{r echo = FALSE}

df_ERC_hike <-  
  results_stch_FR75 %>% 
	as_tibble() %>% 
	select(runname, sim, year, ERC_PR) %>% 
	group_by(runname, sim) %>% 
	mutate(ERC_hike = cumany( ERC_PR - lag(ERC_PR, 5, Inf) > 0.1) ) %>% 
	group_by(runname, year) %>% 
	summarise(ERC_hike = sum(ERC_hike)/n())

fig_title <- "Probability of ERC rate rising more than 10% \nwithin 5 years up to the given year"
df_ERC_hike %>% 
	filter(runname %in% runnames_show1) %>% 
	ggplot(aes(x = year, y = ERC_hike, color = runname)) +  
	geom_line() +
	geom_point() + 
	scale_color_manual(values = c("black", brewer_pal(type = "qual", palette = "Paired")(6) )) + 
	scale_y_continuous(labels = function(x) percent(x, accuracy = 1)) + 
	labs(title = fig_title,
			 x = "Year",
			 y = "Probability",
			 color = "Policy"
			 )
	
```

**Measure 2** Measures to what extent risk-sharing policies can buffer the impact of asset shock occurs: Max increase in ERC rate in 5 years.  

```{r echo= FALSE}
# Table of max increase in ERC rate in 5 years
tab_ERCMaxChg_qtiles <- 
df_ERCMaxChg_qtile %>% 
	select(-runname_wlabel) %>% 
	gather(qtile, value, -runname) %>% 
	mutate(qtile = factor(qtile) %>% fct_inorder()) %>% 
	# mutate(value = 100 * value / value[runname == "baseline" & qtile == "ERC_PV_q50"]) %>% 
	spread(runname, value)

## Explore results for all policies
# tab_ERCMaxChg_qtiles %>% kable(digits = 2)

tab_ERCMaxChg_qtiles %>% 
	select(qtile, one_of(runnames_show1)) %>% 
	knitr::kable(digits = 2, caption = "Max 5-year ERC change, FR=75%", format = 'pandoc')


# Notes:
#  - why does cola_return policy have the lowest compound COLA but does not have the largest cost reduction effect? 

```


**Measure 3** Measure based on sim-to-sim comparison of ERC rate between baseline and risk-sharing policies. 

```{r sim2sim_prep, echo=FALSE, warning=FALSE}
### EXPLORE

## "sim-to-sim" comparison 
df_bySim_FR75 <- 
	left_join(results_stch_FR75 %>% 
							select(runname, runname_wlabel, sim, year, policy_type, ERC, ERC_PR, EEC, EEC_PR, UAAL),
						results_stch_FR75 %>% 
							ungroup %>% 
							filter(runname == "baseline") %>% 
							select(sim, year, ERC_baseline = ERC, 
										            ERC_PR_baseline = ERC_PR,
										            EEC_baseline = EEC, 
										            EEC_PR_baseline = EEC_PR,
										            UAAL_baseline   = UAAL),
						by = c("sim", "year")
	) %>% 
	filter(runname != "cola_baseline") %>% 
	mutate(ERC_PR_diffBySim = ERC_PR - ERC_PR_baseline,
				 ERC_diffBySim    = ERC - ERC_baseline,
				 EEC_PR_diffBySim = EEC_PR - EEC_PR_baseline,
				 EEC_diffBySim    = EEC - EEC_baseline
				 ) 


# **Sim-to-sim compariosn 1**: quantile differences across all sims and years, difference in ERC rate
tab_bySim_ERCptiles <- 
df_bySim_FR75 %>% 
	filter(runname != "baseline") %>% 
	group_by(runname) %>% 
	summarise(diff_ERCrate_90 = quantile(ERC_PR_diffBySim, 0.90),
						diff_ERCrate_75 = quantile(ERC_PR_diffBySim, 0.75),
						diff_ERCrate_50 = quantile(ERC_PR_diffBySim, 0.50),
						diff_ERCrate_25 = quantile(ERC_PR_diffBySim, 0.25),
						diff_ERCrate_10 = quantile(ERC_PR_diffBySim, 0.10)
						) %>% 
	gather(ptile, values, -runname) %>% 
	mutate(ptile = factor(ptile) %>% fct_inorder()) %>% 
	spread(runname, values)


tab_bySim_ERCptiles %>% 
	select(ptile, one_of(runnames_show1)) %>%  
	mutate_at(vars(-ptile), ~.*100) %>% 
	kable(digits = 2, caption = "Sim-to-sim differences of ERC rate across all sim-year observations (%), FR=75%", format = 'pandoc')
	
```


**Other measures**

- Deterministic asset shock scenario: will help policymakers understand the effect of risk-sharing policies in context. Also serves as a deterministic version of measure2 above.   


## Impact of policy parameters (TODO)

```{r eval=FALSE, include=FALSE}
### EXPLORE

## Make tables for draft paper

# Table for PV ERC, w/o final UAAL
tab_PVERC_qtiles <- 
df_PVC_qtiles %>% 
	select(runname, contains("ERC_PV")) %>% 
	gather(qtile, value, -runname) %>% 
	mutate(qtile = factor(qtile) %>% fct_inorder()) %>% 
	mutate(value = 100 * value / value[runname == "baseline" & qtile == "ERC_PV_q50"]) %>% 
	spread(runname, value)

# tab_PVERC_qtiles %>% kable(digits = 1)

tab_PVERC_qtiles %>% select(qtile, one_of(policy_select)) %>% knitr::kable(digits = 1, caption = "PV ERC, FR=75%", format = 'pandoc')
```

```{r sim2sim_2, eval=FALSE, include=FALSE}
### EXPLORE
# **Sim-to-sim compariosn 2**: Dividing simulations into 5 groups based 40-year CAGR, difference in ERC rate:

# 2. Dividing simulations into 5 groups based 40-year CAGR, difference in ERC rate:
#    1) 90th percentile and above []
#    2) 75th~90th percentile [)
#    3) 25th~75th percentile [)
#    4) 25th percentile and below [)
# Grouping can be done based on other variables (e.g. std of return)

df_CAGR40 <- 
results_all %>% 
	filter(runname == "baseline", sim >= 1) %>% 
	group_by(sim) %>% 
	summarise(CAGR40 = get_geoReturn(i.r)) 
  #summarise(CAGR40 = sd(i.r)) 

grpVals_CAGR40 <-
	df_CAGR40 %>% 
	summarise(CAGR40_q90 = quantile(CAGR40, 0.90),
						CAGR40_q75 = quantile(CAGR40, 0.75),
						CAGR40_q50 = quantile(CAGR40, 0.50),
						CAGR40_q25 = quantile(CAGR40, 0.25),
						CAGR40_q10 = quantile(CAGR40, 0.10)
	) 

grpVals_CAGR40

df_CAGR40 %<>% 
	mutate(grp_CAGR40 = case_when(
		CAGR40 >= grpVals_CAGR40$CAGR40_q90 ~ 1,
		CAGR40 >= grpVals_CAGR40$CAGR40_q75 & CAGR40 < grpVals_CAGR40$CAGR40_q90 ~ 2,
		CAGR40 >= grpVals_CAGR40$CAGR40_q25 & CAGR40 < grpVals_CAGR40$CAGR40_q75 ~ 3,
		CAGR40 >= grpVals_CAGR40$CAGR40_q10 & CAGR40 < grpVals_CAGR40$CAGR40_q25 ~ 4,
		CAGR40 < grpVals_CAGR40$CAGR40_q10 ~ 5,
		TRUE ~ NA_real_) 
	)

	
	
df <- 
df_bySim_FR75 %>% 
	left_join(df_CAGR40, by = "sim") %>% 
	# mutate(grp_CAGR40 = case_when(
	# 	CAGR40 >= grpVals_CAGR40$CAGR40_q90 ~ 1,
	# 	CAGR40 >= grpVals_CAGR40$CAGR40_q75 & CAGR40 < grpVals_CAGR40$CAGR40_q90 ~ 2,
	# 	CAGR40 >= grpVals_CAGR40$CAGR40_q25 & CAGR40 < grpVals_CAGR40$CAGR40_q75 ~ 3,
	# 	CAGR40 >= grpVals_CAGR40$CAGR40_q10 & CAGR40 < grpVals_CAGR40$CAGR40_q25 ~ 4,
	# 	CAGR40 < grpVals_CAGR40$CAGR40_q10 ~ 5,
	# 	TRUE ~ NA_real_) 
	# 	) %>% 
	group_by(runname, grp_CAGR40) %>% 
	summarise(diff_ERCrate_avg     = mean(ERC_PR_diffBySim, na.rm = TRUE),
						ERCrate_baseline_avg = mean(ERC_PR_baseline, na.rm = TRUE))
# df


df %>%  
	filter(runname != "baseline") %>% 
	ggplot(aes(x = grp_CAGR40, y = diff_ERCrate_avg, color = runname, shape = runname)) + theme_yy() +
	geom_line()+
	geom_point()


tab_bySim_ERCgrp <- 
df %>% spread(runname, diff_ERCrate_avg)


tab_bySim_ERCgrp %>% knitr::kable(digits = 4)



```



# Analysis of Benefits


**Q1. Impact on the overall benefit level (protection against inflation; focus on total PV benefit)**

**Question:** To what extent do contingent COLA policies weaken the (overall) protection against inflation?

COLA is intended to provide protection against inflation. Even for plans with fixed COLA, few of them provide full protection against inflation (usually fraction of CPI) Contingent COLA policies can even further weaken the inflation protection: lower average COLA; same average COLA but weaker protection in bad scenarios (uncertainty in the strength of protection).

**Measures:**

- Show distribution of 40-year compound COLA

- Two probability based measures for the risk of low overall benefit:

	- Risk of failing to protect against inflation, Measure: Prob of PV benefit is below 90% of PV benefit with full inflation protection
	- Risk of actual overall benefit significantly lower than expected(baseline): Prob of PV benefit is below 90% of PV benefit under baseline

- Distribution of overall benefit level: PV (discount only or + attribution ) Benefit for age 60-100: compared to full projection. The PV values may not be staightforward to understand, but is good to have as a measure for overall benefit. It is also easier to see the tail risk here: how low the PV benefit (campared to full inflation protection or baseline) 



**Q2. Impact on the stability of retirement income (focus on the variability of annual benefit)**

**Question:** Would contingent COLA policies lead to declines in real benefit that may affect retirees welfare? (Related to Q1 but broader)
DB plans are intended to provide secured retirement income. But contingent COLA policies create uncertainty in the benefit payments. The policies may cause deteriorated standard-of-living if retirees experience large declines in real benefit payments that may force them to change their consumption behavior.

**Measures:**

- Measures for the risk of experiencing low benefit sometime during retirement
	- Chance of experiencing low benefit at some point: Prob of real benefits falling below 90% of starting benefit in any year up to a given year
  - Percentiles of the lowest annual real benefit level in 40 years (pick the lowest real B in each sim, then construct the distribution across all sims)  

- Measures for large decline of benefit in a short period of time
	- Chance of sharp decline of real benefit: Prob of real benefits falling by 10% of starting benefit in any year up to a given year
	- Percentiles of max (or 95th ptile) decrease in real benefit in 5-years for a single cohort: percentiles (Tail-risks)

- Range of real benefit level at age 80. Supplemental to other measures. Easier to see the tail risk: how low the real benefit can become (10th percentile)?



**Additional question:** How would the initial funded ratio affect the impact of COLA policies contingent upon funded ratio?


Note: Both interest rate (discount rate) and mortality are taken into account in the calculation of PV




```{r benefit_prep, include = FALSE}

# Cohorts to examine:
	# Cohort 1: Retired at age 60 in year 1 (1 - 41)
	# Cohort 2: Retired at age 60 in year 15 (15- 55)
		#  - After the 15-year amortization period for the year-1 UAAL 

# Normalize the benefit at age 60 to 100. 
# Need qxm.r in decrement table 

load("Inputs/riskShaing_demographics_100y.RData")

## Create a model run with cola_actual = infl and append to results_all

df_colaFull <- 
  results_all %>% 
	filter(runname == "baseline") %>% 
	mutate(cola_actual = infl,
				 runname     = "cola_full")

df_benefit_y1 <- 
	bind_rows(results_all, df_colaFull) %>% 
	filter(sim >= 1, year %in% 1:41) %>% 
	select(runname, runname_wlabel, policy_type, sim, year, cola_actual) %>% 
	group_by(runname, sim) %>% 
	mutate(age = 60:100) %>% 
	left_join(decrement %>% ungroup() %>% filter(ea == min(ea))  %>% select(age, qxm.r) , by = "age") %>% 
	mutate(qxm.r   = ifelse(age == max(age), 1, qxm.r),
				 fct_qxm = ifelse(age == 60, 1, lag(cumprod(1-qxm.r))),
				 fct_dr  = 1/(1 + dr)^(age - 60),
				 B       = 100 * ifelse(age == 60, 1, lag(cumprod(1+cola_actual))),
				 B_real  = B / (1 + infl)^(age - 60),
				 B_real_chg5y = rollapply(B_real, width = 6, get_nyearMin, fill = NA, align = "right")
				 )
# df_benefit_y1 


df_benefit_qtile_y1 <- 
	df_benefit_y1 %>% 
	summarise(runname_wlabel = unique(runname_wlabel),
						B_PV_dr    = sum(B * fct_dr),
						B_PV_tot   = sum(B* fct_dr * fct_qxm),
						B_real_chg5yMin = min(B_real_chg5y, na.rm = TRUE),
						B_real_age80   = B_real[age == 80]		
	) %>% 
	summarise(runname_wlabel = unique(runname_wlabel),
						
						B_PV_dr_q90 = quantile(B_PV_dr, 0.90),
						B_PV_dr_q75 = quantile(B_PV_dr, 0.75),
						B_PV_dr_q50 = quantile(B_PV_dr, 0.50),
						B_PV_dr_q25 = quantile(B_PV_dr, 0.25),
						B_PV_dr_q10 = quantile(B_PV_dr, 0.1),
						
						B_PV_tot_q90 = quantile(B_PV_tot, 0.90),
						B_PV_tot_q75 = quantile(B_PV_tot, 0.75),
						B_PV_tot_q50 = quantile(B_PV_tot, 0.50),
						B_PV_tot_q25 = quantile(B_PV_tot, 0.25),
						B_PV_tot_q10 = quantile(B_PV_tot, 0.1),
						
						B_real_chg5yMin_q90 = quantile(B_real_chg5yMin, 0.90),
						B_real_chg5yMin_q75 = quantile(B_real_chg5yMin, 0.75),
						B_real_chg5yMin_q50 = quantile(B_real_chg5yMin, 0.50),
						B_real_chg5yMin_q25 = quantile(B_real_chg5yMin, 0.25),
						B_real_chg5yMin_q10 = quantile(B_real_chg5yMin, 0.1),
						
						B_real_age80_q90 = quantile(B_real_age80, 0.90),
						B_real_age80_q75 = quantile(B_real_age80, 0.75),
						B_real_age80_q50 = quantile(B_real_age80, 0.50),
						B_real_age80_q25 = quantile(B_real_age80, 0.25),
						B_real_age80_q10 = quantile(B_real_age80, 0.1)
						)



# runs_benefit <- c("cola_full", "baseline", "cola_return", "cola_FR", "cola_SDRS", "cola_FR_FR100", "cola_SDRS_FR100")
# runs_benefit_lables <- c(
# 	"COLA equal to inflation",
# 	"Baseline \nYear-1 funded ratio 100%",
# 	"Contingent COLA: \nreturn",
# 	"Contingent COLA: \nFunded ratio threshold",
# 	"SDRS",
# 	"Contingent COLA: \nFunded ratio threshold\nYear-1 funded ratio 100%",
# 	"SDRS \nYear-1 funded ratio 100%"
# )
	

# Distribution of 40-year COLA with 75% initial funded ratio
df_cola <- 
	results_all %>% 
	filter(year %in% 1:40) %>% 
	# filter(year %in% 16:55) %>% 
	filter(sim >= 1, str_detect(runname, "cola|baseline") ) %>% 
	group_by(runname, sim) %>%
	summarise(runname_wlabel = unique(runname_wlabel),
						cola_avg  = prod(1 + cola_actual[-n()])^(1/(n() - 1)) - 1)

df_cola_qtiles <- 
	df_cola %>% 
	summarise(runname_wlabel = unique(runname_wlabel),
						cola_avg_q10 = quantile(cola_avg, 0.1),
						cola_avg_q25 = quantile(cola_avg, 0.25),
						cola_avg_q50 = quantile(cola_avg, 0.50),
						cola_avg_q75 = quantile(cola_avg, 0.75),
						cola_avg_q90 = quantile(cola_avg, 0.90)
						)




```



## Impact on overall benefit level and protection against inflation

**Dsitribution of 40-year compound COLA**

```{r dist_COLA, fig.width=8, echo = FALSE}


fig_title    <- "Distributions of 40-year compound annual COLA \nunder different COLA policies"
# fig_subtitle <- "Starting funded ratio: 75%"
fig_cola_qtiles_FR75 <- 
	df_cola_qtiles %>% 
	filter(runname %in% runnames_show2) %>% 
	ggplot(aes(x = runname)) + 
	geom_boxplot(width = 0.3,
							 stat = "identity",
							 aes(ymin   = cola_avg_q10,
							 		lower  = cola_avg_q25,
							 		middle = cola_avg_q50,
							 		upper  = cola_avg_q75,
							 		ymax   = cola_avg_q90)
	) +
	geom_hline(yintercept =
						 filter(df_cola_qtiles, runname == "baseline") %>% pull(cola_avg_q50),
						 linetype = 2) +
	coord_cartesian(ylim = c(0, 0.025)) + 
	scale_y_continuous(breaks = seq(0, 1, 0.0025), labels = percent) + 
	labs(title = fig_title,
			 subtitle = NULL,# fig_subtitle,
			 x = NULL, 
			 y = "Compound annual COLA")
fig_cola_qtiles_FR75


```

**Two probability based measures for the risk of low overall benefit**:

- Risk of failing to protect against inflation: Prob of PV benefit is below 90% of PV benefit with full inflation protection
- Risk of actual overall benefit significantly lower than expected(baseline): Prob of PV benefit is below 90% of PV benefit under baseline


```{r echo=FALSE}

df_benefit_PV <- 
	df_benefit_y1 %>% 
	summarise(runname_wlabel = unique(runname_wlabel),
						# B_PV_dr    = sum(B * fct_dr),
						B_PV_tot   = sum(B* fct_dr * fct_qxm)
	)

df_low_pvB <- 
df_benefit_PV %>% 
	left_join(filter(df_benefit_PV, runname == "cola_full") %>% 
							ungroup %>%  select(sim, B_PV_tot_full = B_PV_tot), by = "sim") %>% 
  left_join(filter(df_benefit_PV, runname == "baseline") %>% 
  						ungroup %>%  select(sim, B_PV_tot_baseline = B_PV_tot), by = "sim") %>% 
	mutate(dif_full     = B_PV_tot / B_PV_tot_full,
				 dif_baseline = B_PV_tot / B_PV_tot_baseline
				 ) %>% 
	group_by(runname) %>% 
	summarise(Low_pvB_full_pct90     = 100 * sum(dif_full     <= 0.9)/n(),
						Low_pvB_baseline_pct90 = 100 * sum(dif_baseline <= 0.9)/n(),
						
						Low_pvB_full_pct95     = 100 * sum(dif_full     <= 0.95)/n(),
						Low_pvB_baseline_pct95 = 100 * sum(dif_baseline <= 0.95)/n(),
						)


df_low_pvB %>% 
	filter(runname %in% runnames_show2) %>% 
	mutate(runname = factor(runname, levels = runnames_show2)) %>% 
	gather(Measure, value, -runname) %>% 
	spread(runname, value) %>% 
	kable(digits = 1, caption = "Probability (%) of PV benefit below 90%/95% of that in baseline (cola = 1.5%) or full inflation protection(cola = 2%)", format = 'pandoc')
	
```


**Distribution of PV Benefit**

```{r echo = FALSE}

## Q1 measures
  # B_PV total and B_real_age80
  # runs: baseline, cola_return, cola_FR, cola_SDRS, cola_FR100, cola_SDRS_100

tab_benefit1 <- 
df_benefit_qtile_y1 %>% 
	filter(runname %in% c("cola_full", runnames_show2)) %>% 
	select(runname, starts_with("B_PV_tot")) %>% 
	gather(Var, values, -runname) %>%
	mutate(runname = factor(runname, levels=  c("cola_full", runnames_show2)),
		     # Var = factor(Var) %>% fct_inorder(),
				 values = ifelse(str_detect(Var, "B_PV_tot"),  100 * values / values[runname == "baseline" & Var == "B_PV_tot_q50"], values)
	) %>% 
	spread(runname, values) 
tab_benefit1 %>% knitr::kable(digits = 1)

```

## Impact on the stability of retirement income (variability of annual benefit)


**Measures for the risk of experiencing low benefit sometime during retirement**

- Chance of experiencing low benefit in certain years: Prob of real benefits falling below 90% of starting benefit in any year up to a given year
- Percentiles of the lowest annual real benefit level in 40 years (pick the lowest real B in each sim, then construct the distribution across all sims)  


```{r, echo = FALSE}

df_B_low <- 
df_benefit_y1 %>% 
	as_tibble() %>% 
	select(runname, runname_wlabel, sim, year, B_real) %>% 
	group_by(runname, sim) %>% 
	mutate(B_lower90 = cumany(B_real < 90)) %>% 
	group_by(runname, year) %>% 
	summarise(B_lower90 = sum(B_lower90) /n())
	

fig_title <- "Probability of real benefit falling below 90% of starting benefit \nin any year up to a given year"
df_B_low %>% 
	filter(runname %in% runnames_show2) %>% 
	ungroup %>% 
	mutate(runname = factor(runname, levels= runnames_show2)) %>% 
	ggplot(aes(x = year, y = B_lower90, color = runname)) +  
	geom_line() +
	geom_point() + 
	scale_color_manual(values = c("black", "grey50", brewer_pal(type = "qual", palette = "Paired")(6) )) + 
	scale_y_continuous(labels = function(x) percent(x, accuracy = 1)) + 
	labs(title = fig_title,
			 x = "Year",
			 y = "Probability",
			 color = "Policy"
			 )


df_B_lowest <- 
df_benefit_y1 %>% 
	as_tibble() %>% 
	select(runname, runname_wlabel, sim, year, B_real) %>% 
	group_by(runname, sim) %>% 
	summarise(B_lowest = min(B_real)) %>% 
	summarise(B_lowest_q90 = quantile(B_lowest, 0.9),
						B_lowest_q50 = quantile(B_lowest, 0.5),
						B_lowest_q10 = quantile(B_lowest, 0.1)
						)


df_B_lowest %>% 
	filter(runname %in% runnames_show2) %>% 
	ungroup %>%
	mutate(runname = factor(runname, levels= runnames_show2)) %>% 
	gather(Percentile, value, -runname) %>% 
	mutate(Percentile = factor(Percentile) %>% fct_inorder()) %>% 
	spread(runname, value) %>% 
	kable(digits = 1, caption = "Distribution of the lowest annual real benefit level in 40 years (100 in year 1)", format = 'pandoc')
	
	
```




**Measures for large decline of benefit in a short period of time**

- Chance of sharp decline of real benefit: Prob of real benefits falling by 8% of starting benefit in any year up to a given year (8% is arbitrary for now)
- Percentiles of max (or 95th ptile) decrease in real benefit in 5-years for a single cohort: percentiles (Tail-risks)



```{r, echo = FALSE}

df_B_drop <- 
df_benefit_y1 %>% 
	as_tibble() %>% 
	select(runname, runname_wlabel, sim, year, B_real) %>% 
	group_by(runname, sim) %>% 
	mutate(B_drop_5 = cumany(B_real - lag(B_real, 5, -Inf) <= -8)) %>% 
	group_by(runname, year) %>% 
	summarise(B_drop_5 = sum(B_drop_5) /n())

# df_B_drop	

fig_title <- "Probability of real benefits falling by 8% of starting benefit \nin any year up to a given year"
df_B_drop %>% 
	filter(runname %in% runnames_show2) %>% 
	ungroup %>% 
	mutate(runname = factor(runname, levels= runnames_show2)) %>% 
	ggplot(aes(x = year, y = B_drop_5, color = runname)) +  
	geom_line() +
	geom_point() + 
	scale_color_manual(values = c("black", "grey50", brewer_pal(type = "qual", palette = "Paired")(6) )) + 
	scale_y_continuous(labels = function(x) percent(x, accuracy = 1)) + 
	labs(title = fig_title,
			 x = "Year",
			 y = "Probability",
			 color = "Policy"
			 )



# Max 5-year benefit change
tab_benefit2 <- 
df_benefit_qtile_y1 %>% 
	filter(runname %in% runnames_show2) %>% 
	select(runname, starts_with("B_real_chg5yMin")) %>% 
	gather(Var, values, -runname) %>%
	mutate(runname = factor(runname, levels= runnames_show2),
				 Var = factor(Var) %>% fct_inorder()
	) %>% 
	spread(runname, values)

tab_benefit2 %>% 
	kable(digits = 2,
				caption = "Distribution of max decrease in real benefit in 5-years", 
				format = 'pandoc')




# # Probability of benefit falling below 90% of starting benefit
# df_benefit_probLowBen <- 
# df_benefit_y1 %>% 
# 	filter(runname %in% setdiff(runs_benefit,c("baseline", "cola_full"))) %>% 
# 	ungroup() %>% 
# 	mutate(runname = factor(runname, levels = runs_benefit, labels = runs_benefit_lables)) %>% 
# 	group_by(runname, sim) %>% 
# 	mutate(B_real_low = cumany(B_real <= 90)) %>% 
# 	group_by(runname, year) %>% 
# 	summarise(B_real_low = sum(B_real_low)/n()) 
# 
# 
# fig_title <- "Probability of inflation-adjusted benefit falling below 90% of the year-1 value\n at anytime up ot the given year"
# fig_benefit_probLowBen <- 
# df_benefit_probLowBen %>% 
# 	ggplot(aes(y = B_real_low, x = year, color = runname, shape = runname)) + theme_yy() +
# 	geom_line() + 
# 	geom_point() + 
# 	scale_y_continuous(labels = percent) +
# 	# scale_color_viridis_d(option = "D", begin = 0.3) + 
# 	scale_color_brewer(type = "qual", palette = 3)+
# 	labs(title = fig_title,
# 			 x = "Year",
# 			 y = "Probability",
# 		   color = NULL,
# 			 shape = NULL) +
# 	guides(color = guide_legend(keywidth = 1.5, keyheight = 3))
# fig_benefit_probLowBen
# 
# save_figure(fig_benefit_probLowBen, dir_outputs, w = 9, h = 6 )

```



**Range of real benefit level at age 80**. Supplemental to other measures. Easier to see the tail risk: how low the real benefit can become (10th percentile)?

```{r echo = FALSE}

## Q1 measures
  # B_PV total and B_real_age80
  # runs: baseline, cola_return, cola_FR, cola_SDRS, cola_FR100, cola_SDRS_100

tab_benefit_age80 <- 
df_benefit_qtile_y1 %>% 
	filter(runname %in% c("cola_full", runnames_show2)) %>% 
	select(runname, starts_with("B_real_age80")) %>% 
	gather(Var, values, -runname) %>%
	mutate(runname = factor(runname, levels=  c("cola_full", runnames_show2)),
		     Var = factor(Var) %>% fct_inorder(),
	) %>% 
	spread(runname, values) 
tab_benefit_age80 %>% knitr::kable(digits = 1)

```




```{r eval=FALSE, include=FALSE}
# Distribution of 40-year COLA with 75% initial funded ratio
df_cola <- 
	results_all %>% 
	filter(year %in% 1:40) %>% 
	# filter(year %in% 16:55) %>% 
	filter(sim >= 1, str_detect(runname, "cola|baseline") ) %>% 
	group_by(runname, sim) %>%
	summarise(runname_wlabel = unique(runname_wlabel),
						cola_avg  = prod(1 + cola_actual[-n()])^(1/(n() - 1)) - 1)

df_cola_qtiles <- 
	df_cola %>% 
	summarise(runname_wlabel = unique(runname_wlabel),
						cola_avg_q10 = quantile(cola_avg, 0.1),
						cola_avg_q25 = quantile(cola_avg, 0.25),
						cola_avg_q50 = quantile(cola_avg, 0.50),
						cola_avg_q75 = quantile(cola_avg, 0.75),
						cola_avg_q90 = quantile(cola_avg, 0.90)
						)

df_cola_qtiles_FR75 <- 
	df_cola_qtiles %>% 
	filter(!str_detect(runname, "FR100"))

levels(df_cola_qtiles_FR75$runname_wlabel)[df_cola_qtiles_FR75$runname]

df_cola_qtiles_FR100 <- 
	df_cola_qtiles %>% 
	filter(str_detect(runname, "FR100")) %>% 
	mutate(runname_wlabel = factor(runname, 
																 levels = runname, 
																 labels = levels(df_cola_qtiles_FR75$runname_wlabel)[df_cola_qtiles_FR75$runname])) 
df_cola_qtiles_FR100
```


```{r eval=FALSE, include=FALSE}
fig_title    <- "Distributions of 40-year compound annual COLA \nunder different COLA policies"
fig_subtitle <- "Starting funded ratio: 75%"
fig_cola_qtiles_FR75 <- 
	df_cola_qtiles_FR75 %>% 
	# filter(runname %in% runname_stch) %>% 
	ggplot(aes(x = runname_wlabel)) + theme_yy() + 
	geom_boxplot(width = 0.3,
							 stat = "identity",
							 aes(ymin   = cola_avg_q10,
							 		lower  = cola_avg_q25,
							 		middle = cola_avg_q50,
							 		upper  = cola_avg_q75,
							 		ymax   = cola_avg_q90)
	) +
	geom_hline(yintercept =
						 	filter(df_cola_qtiles, runname == "baseline") %>% pull(cola_avg_q50),
						 linetype = 2) +
	coord_cartesian(ylim = c(0, 0.025)) + 
	scale_y_continuous(breaks = seq(0, 1, 0.0025), labels = percent) + 
	labs(title = fig_title,
			 subtitle = fig_subtitle,
			 x = NULL, 
			 y = "Compound annual COLA")
fig_cola_qtiles_FR75


fig_title    <- "Distributions of 40-year compound annual COLA \nunder different COLA policies"
fig_subtitle <- "Starting funded ratio: 100%"
fig_cola_qtiles_FR100 <- 
	df_cola_qtiles_FR100 %>% 
	# filter(runname %in% runname_stch) %>% 
	ggplot(aes(x = runname_wlabel)) + theme_yy() + 
	geom_boxplot(width = 0.3,
							 stat = "identity",
							 aes(ymin   = cola_avg_q10,
							 		lower  = cola_avg_q25,
							 		middle = cola_avg_q50,
							 		upper  = cola_avg_q75,
							 		ymax   = cola_avg_q90)
	) +
	geom_hline(yintercept =
						 	filter(df_cola_qtiles, runname == "baseline") %>% pull(cola_avg_q50),
						 linetype = 2) +
	coord_cartesian(ylim = c(0, 0.025)) + 
	scale_y_continuous(breaks = seq(0, 1, 0.0025), labels = percent) + 
	labs(title = fig_title,
			 subtitle = fig_subtitle,
			 x = NULL, 
			 y = "Compound annual COLA")
fig_cola_qtiles_FR100



# The impact of funded ratio can be very large for FR-based policies: 
#   - The legacy UAAL was largely accrued during the working years of the current retirees,
#   - so making the current retirees bear the cost is consistent with inter-generational equity.
#   - But current retirees will need to bear risk of with all NEW UAALs, which are associated
#   - with all members (active and retired). 
# 
# Return based cola is NOT affected by legacy underfunding.   


save_figure(fig_cola_qtiles_FR75, dir_outputs, w = 8,  h = 5)
save_figure(fig_cola_qtiles_FR100, dir_outputs, w = 8,  h = 5)


# Distribution of 40-year COLA with 100% initial funded ratio



```














